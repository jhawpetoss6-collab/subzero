<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
<meta name="theme-color" content="#0a0a12">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<link rel="manifest" href="manifest.json">
<link rel="icon" href="favicon.png">
<link rel="apple-touch-icon" href="icon-192.png">
<title>Spine Rip â€” SubZero</title>
<style>
:root {
  --bg:       #0a0a12;
  --bg2:      #08080f;
  --bg3:      #0e0e1a;
  --bg4:      #14142a;
  --bg-input: #10101c;
  --fg:       #c8c8d0;
  --fg-dim:   #55556a;
  --accent:   #03dac6;
  --blue:     #0088ff;
  --blue2:    #00aaff;
  --purple:   #bb86fc;
  --green:    #00e676;
  --red:      #ef5350;
  --orange:   #ffab00;
  --border:   #1a1a2e;
  --bubble-user: #0a2e4a;
  --bubble-bot:  #0e0e1a;
  --header:   #06060c;
}
.light {
  --bg:       #f0f2f5;
  --bg2:      #ffffff;
  --bg3:      #e8eaed;
  --bg4:      #d4d6da;
  --bg-input: #ffffff;
  --fg:       #1a1a2e;
  --fg-dim:   #8a8a9a;
  --accent:   #03a896;
  --border:   #d0d2d6;
  --bubble-user: #0a2e4a;
  --bubble-bot:  #e8eaed;
  --header:   #0a0a12;
}
* { margin:0; padding:0; box-sizing:border-box; }
body {
  font-family: -apple-system, 'Segoe UI', Roboto, sans-serif;
  background: var(--bg);
  color: var(--fg);
  height: 100vh; width: 100vw;
  overflow: hidden;
  -webkit-tap-highlight-color: transparent;
}
/* â”€â”€ SCREENS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.screen { display:none; position:absolute; inset:0; flex-direction:column; }
.screen.active { display:flex; }
/* â”€â”€ HEADER BAR (Telegram style) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.header {
  background: var(--header); height:56px; display:flex; align-items:center;
  padding:0 8px; gap:8px; flex-shrink:0; z-index:10;
  border-bottom: 1px solid var(--border);
}
.light .header { background: #0a0a12; color:#fff; }
.header .back { width:40px;height:40px;border:none;background:none;color:#fff;font-size:22px;cursor:pointer;border-radius:50%;display:flex;align-items:center;justify-content:center; }
.header .back:active { background:rgba(255,255,255,.1); }
.header .avatar { width:40px;height:40px;border-radius:50%;object-fit:cover; }
.header .info { flex:1;margin-left:4px; }
.header .info .name { color:#fff;font-size:16px;font-weight:600; }
.header .info .status { font-size:12px;color:var(--accent); }
.header .hbtn { width:40px;height:40px;border:none;background:none;color:#fff;font-size:20px;cursor:pointer;border-radius:50%;display:flex;align-items:center;justify-content:center; }
.header .hbtn:active { background:rgba(255,255,255,.1); }
/* â”€â”€ HAMBURGER / SIDE DRAWER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.overlay { display:none;position:fixed;inset:0;background:rgba(0,0,0,.5);z-index:50; }
.overlay.open { display:block; }
.drawer {
  position:fixed;top:0;left:-280px;width:280px;height:100%;
  background:var(--bg2);z-index:51;transition:left .25s ease;
  display:flex;flex-direction:column;
}
.drawer.open { left:0; }
.drawer-header {
  background:var(--header);padding:20px 16px 16px;
}
.light .drawer-header { background:#0a0a12; }
.drawer-header img { width:56px;height:56px;border-radius:50%; }
.drawer-header .dname { color:#fff;font-size:16px;font-weight:600;margin-top:12px; }
.drawer-header .dsub { color:var(--accent);font-size:13px; }
.drawer-items { flex:1;overflow-y:auto;padding:8px 0; }
.drawer-item {
  display:flex;align-items:center;gap:16px;padding:14px 24px;cursor:pointer;
  color:var(--fg);font-size:15px;
}
.drawer-item:active { background:var(--bg4); }
.drawer-item .di-icon { font-size:20px;width:24px;text-align:center;color:var(--fg-dim); }
.drawer-sep { height:1px;background:var(--border);margin:8px 0; }
.drawer-footer { padding:16px 24px;color:var(--fg-dim);font-size:12px; }
/* â”€â”€ HOME SCREEN (Chat list) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.home-header {
  background: var(--header); height:56px; display:flex; align-items:center;
  padding:0 8px; gap:8px; flex-shrink:0;
  border-bottom:1px solid var(--border);
}
.light .home-header { background:#0a0a12; color:#fff; }
.home-header .hamburger { width:40px;height:40px;border:none;background:none;color:#fff;font-size:22px;cursor:pointer;border-radius:50%;display:flex;align-items:center;justify-content:center; }
.home-header .hamburger:active { background:rgba(255,255,255,.1); }
.home-header .title { flex:1;color:#fff;font-size:20px;font-weight:700;letter-spacing:1px; }
.home-header .search-btn { width:40px;height:40px;border:none;background:none;color:#fff;font-size:20px;cursor:pointer;border-radius:50%; }
.chat-list { flex:1;overflow-y:auto; }
.chat-card {
  display:flex;align-items:center;gap:12px;padding:10px 16px;cursor:pointer;
  border-bottom:1px solid var(--border);
}
.chat-card:active { background:var(--bg4); }
.chat-card img { width:52px;height:52px;border-radius:50%;object-fit:cover; }
.chat-card .cc-info { flex:1; }
.chat-card .cc-top { display:flex;justify-content:space-between;align-items:center; }
.chat-card .cc-name { font-size:15px;font-weight:600; }
.chat-card .cc-time { font-size:12px;color:var(--fg-dim); }
.chat-card .cc-preview { font-size:13px;color:var(--fg-dim);margin-top:2px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:60vw; }
.chat-card .cc-badge { background:var(--accent);color:#000;border-radius:50%;width:22px;height:22px;font-size:12px;font-weight:700;display:flex;align-items:center;justify-content:center; }
.fab {
  position:absolute;bottom:20px;right:20px;width:56px;height:56px;
  border-radius:50%;background:var(--accent);border:none;color:#000;
  font-size:24px;cursor:pointer;box-shadow:0 4px 12px rgba(3,218,198,.3);
  display:flex;align-items:center;justify-content:center;
}
.fab:active { background:#04f0d8; }
/* â”€â”€ CHAT SCREEN â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.messages {
  flex:1;overflow-y:auto;padding:8px 8px 8px;
  display:flex;flex-direction:column;gap:2px;
  background:var(--bg);
}
.msg-date {
  text-align:center;margin:12px 0 8px;font-size:12px;color:var(--fg-dim);
  background:var(--bg3);display:inline-block;padding:4px 12px;border-radius:12px;
  align-self:center;
}
.msg {
  max-width:82%;padding:8px 12px;border-radius:12px;font-size:14px;
  line-height:1.45;position:relative;word-wrap:break-word;
  animation: msgIn .2s ease;
}
@keyframes msgIn { from{opacity:0;transform:translateY(8px)} to{opacity:1;transform:none} }
.msg.user {
  background:var(--bubble-user);color:#e0e8f0;align-self:flex-end;
  border-bottom-right-radius:4px;
}
.msg.bot {
  background:var(--bubble-bot);color:var(--fg);align-self:flex-start;
  border-bottom-left-radius:4px;border:1px solid var(--border);
}
.light .msg.bot { background:#e8eaed;color:#1a1a2e;border:none; }
.msg .time {
  font-size:10px;color:var(--fg-dim);float:right;margin:4px 0 -2px 12px;
}
.msg .check { color:var(--accent);font-size:10px;margin-left:2px; }
.msg code {
  background:rgba(255,255,255,.08);padding:1px 5px;border-radius:3px;
  font-family:'Consolas',monospace;font-size:13px;
}
.light .msg code { background:rgba(0,0,0,.06); }
.msg pre {
  background:#06060c;padding:10px;border-radius:8px;margin:6px 0;
  overflow-x:auto;font-family:'Consolas',monospace;font-size:12px;color:#00e676;
}
.light .msg pre { background:#1a1a2e;color:#00e676; }
.msg .tool-result {
  background:rgba(3,218,198,.08);border-left:3px solid var(--accent);
  padding:6px 10px;margin:6px 0;border-radius:0 6px 6px 0;font-size:13px;
}
.typing-indicator {
  align-self:flex-start;background:var(--bubble-bot);border:1px solid var(--border);
  padding:12px 16px;border-radius:12px;border-bottom-left-radius:4px;
  display:none;gap:4px;align-items:center;
}
.typing-indicator.show { display:flex; }
.typing-dot {
  width:8px;height:8px;border-radius:50%;background:var(--fg-dim);
  animation:typingBounce .6s infinite alternate;
}
.typing-dot:nth-child(2){animation-delay:.2s}
.typing-dot:nth-child(3){animation-delay:.4s}
@keyframes typingBounce{0%{opacity:.3;transform:translateY(0)}100%{opacity:1;transform:translateY(-4px)}}
.scroll-bottom {
  position:absolute;bottom:70px;right:16px;width:40px;height:40px;
  border-radius:50%;background:var(--bg3);border:1px solid var(--border);
  color:var(--fg);font-size:18px;cursor:pointer;display:none;
  align-items:center;justify-content:center;z-index:5;
}
.scroll-bottom.show { display:flex; }
/* â”€â”€ INPUT BAR â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.input-bar {
  display:flex;align-items:flex-end;gap:6px;padding:6px 8px;
  background:var(--bg2);border-top:1px solid var(--border);flex-shrink:0;
}
.input-bar .attach {
  width:40px;height:40px;border:none;background:none;color:var(--fg-dim);
  font-size:22px;cursor:pointer;border-radius:50%;flex-shrink:0;
}
.input-bar .attach:active { background:var(--bg4); }
.input-bar textarea {
  flex:1;background:var(--bg-input);color:var(--fg);border:1px solid var(--border);
  border-radius:20px;padding:10px 16px;font-size:15px;resize:none;
  font-family:inherit;max-height:120px;min-height:40px;line-height:1.3;
  outline:none;
}
.input-bar textarea:focus { border-color:var(--accent); }
.input-bar textarea::placeholder { color:var(--fg-dim); }
.input-bar .send {
  width:44px;height:44px;border:none;border-radius:50%;
  background:var(--accent);color:#000;font-size:20px;cursor:pointer;
  display:flex;align-items:center;justify-content:center;flex-shrink:0;
  transition:background .15s;
}
.input-bar .send:active { background:#04f0d8; }
.input-bar .send.disabled { background:var(--bg4);color:var(--fg-dim);pointer-events:none; }
/* â”€â”€ CONTEXT MENU (long press on message) â”€â”€ */
.ctx-menu {
  display:none;position:fixed;background:var(--bg2);border:1px solid var(--border);
  border-radius:12px;padding:6px 0;z-index:100;min-width:160px;
  box-shadow:0 8px 24px rgba(0,0,0,.4);
}
.ctx-menu.open { display:block; }
.ctx-item { padding:12px 20px;font-size:14px;cursor:pointer;display:flex;align-items:center;gap:12px; }
.ctx-item:active { background:var(--bg4); }
.ctx-icon { font-size:16px;color:var(--fg-dim);width:20px;text-align:center; }
/* â”€â”€ SETTINGS SCREEN â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.settings-body { flex:1;overflow-y:auto;padding:0; }
.settings-profile {
  display:flex;flex-direction:column;align-items:center;padding:24px;
  background:var(--bg2);border-bottom:1px solid var(--border);
}
.settings-profile img { width:80px;height:80px;border-radius:50%; }
.settings-profile .sp-name { font-size:18px;font-weight:700;margin-top:12px; }
.settings-profile .sp-sub { font-size:13px;color:var(--accent);margin-top:2px; }
.settings-group { padding:16px 0 8px 20px;font-size:13px;color:var(--accent);font-weight:600; }
.settings-item {
  display:flex;align-items:center;gap:16px;padding:14px 20px;cursor:pointer;
  border-bottom:1px solid var(--border);
}
.settings-item:active { background:var(--bg4); }
.si-icon { font-size:20px;color:var(--fg-dim);width:24px;text-align:center; }
.si-content { flex:1; }
.si-label { font-size:15px; }
.si-desc { font-size:12px;color:var(--fg-dim);margin-top:1px; }
.si-right { color:var(--fg-dim);font-size:14px; }
/* Toggle switch */
.toggle { position:relative;width:44px;height:24px;flex-shrink:0; }
.toggle input { opacity:0;width:0;height:0; }
.toggle .slider {
  position:absolute;inset:0;background:var(--bg4);border-radius:12px;cursor:pointer;
  transition:.2s;
}
.toggle .slider:before {
  content:"";position:absolute;width:18px;height:18px;border-radius:50%;
  background:#fff;left:3px;top:3px;transition:.2s;
}
.toggle input:checked + .slider { background:var(--accent); }
.toggle input:checked + .slider:before { transform:translateX(20px); }
/* â”€â”€ WALLET SCREEN â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.wallet-body { flex:1;overflow-y:auto;padding:16px; }
.wallet-card {
  background:linear-gradient(135deg, #0a2e4a, #0e0e1a);
  border:1px solid var(--border);border-radius:16px;padding:20px;margin-bottom:16px;
}
.light .wallet-card { background:linear-gradient(135deg,#e0f0ff,#f0f2f5);border-color:#d0d2d6; }
.wallet-card .wc-label { font-size:13px;color:var(--fg-dim); }
.wallet-card .wc-balance { font-size:28px;font-weight:700;margin:4px 0;color:var(--accent); }
.wallet-card .wc-usd { font-size:14px;color:var(--fg-dim); }
.wallet-actions { display:flex;gap:12px;margin:16px 0; }
.wallet-actions button {
  flex:1;padding:12px;border:1px solid var(--border);border-radius:12px;
  background:var(--bg3);color:var(--fg);font-size:14px;cursor:pointer;
  display:flex;flex-direction:column;align-items:center;gap:4px;
}
.wallet-actions button:active { background:var(--bg4); }
.wallet-actions .wa-icon { font-size:22px; }
.wallet-section { margin-top:16px; }
.wallet-section .ws-title { font-size:14px;font-weight:600;margin-bottom:8px;color:var(--accent); }
.wallet-coin {
  display:flex;align-items:center;gap:12px;padding:12px;
  background:var(--bg2);border:1px solid var(--border);border-radius:12px;margin-bottom:8px;
}
.wallet-coin .wco-icon { font-size:28px; }
.wallet-coin .wco-info { flex:1; }
.wallet-coin .wco-name { font-size:14px;font-weight:600; }
.wallet-coin .wco-amount { font-size:12px;color:var(--fg-dim); }
.wallet-coin .wco-price { text-align:right; }
.wallet-coin .wco-val { font-size:14px;font-weight:600; }
.wallet-coin .wco-change { font-size:12px; }
.wco-change.up { color:var(--green); }
.wco-change.down { color:var(--red); }
.wallet-connect-section { margin-top:20px;padding:16px;background:var(--bg2);border:1px solid var(--border);border-radius:12px; }
.wallet-connect-section .wcs-title { font-size:14px;font-weight:600;margin-bottom:4px; }
.wallet-connect-section .wcs-desc { font-size:12px;color:var(--fg-dim);margin-bottom:12px; }
.wallet-connect-btn {
  width:100%;padding:12px;border:1px solid var(--accent);border-radius:10px;
  background:transparent;color:var(--accent);font-size:14px;font-weight:600;cursor:pointer;
}
.wallet-connect-btn:active { background:rgba(3,218,198,.1); }
.api-key-input {
  width:100%;padding:10px 12px;background:var(--bg-input);color:var(--fg);
  border:1px solid var(--border);border-radius:8px;font-size:13px;margin-top:8px;
  font-family:monospace;outline:none;
}
.api-key-input:focus { border-color:var(--accent); }
.api-key-input::placeholder { color:var(--fg-dim); }
/* â”€â”€ TAP TO PAY â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.pay-body { flex:1;overflow-y:auto;padding:16px; }
.pay-hero {
  text-align:center;padding:24px 0 16px;
}
.pay-hero .pay-icon { font-size:64px;margin-bottom:8px; }
.pay-hero .pay-title { font-size:18px;font-weight:700;color:var(--accent); }
.pay-hero .pay-sub { font-size:13px;color:var(--fg-dim);margin-top:4px; }
.pay-amount-box {
  background:var(--bg2);border:1px solid var(--border);border-radius:16px;
  padding:20px;text-align:center;margin:16px 0;
}
.pay-amount-box input {
  background:transparent;border:none;color:var(--accent);font-size:36px;
  font-weight:700;text-align:center;width:100%;outline:none;
  font-family:inherit;
}
.pay-amount-box input::placeholder { color:var(--fg-dim); }
.pay-amount-box .pay-usd { font-size:14px;color:var(--fg-dim);margin-top:4px; }
.pay-coin-select {
  display:flex;gap:8px;justify-content:center;margin:12px 0 20px;
}
.pay-coin-btn {
  padding:8px 16px;border:1px solid var(--border);border-radius:20px;
  background:var(--bg3);color:var(--fg);font-size:13px;font-weight:600;
  cursor:pointer;transition:.15s;
}
.pay-coin-btn.active { background:var(--accent);color:#000;border-color:var(--accent); }
.pay-coin-btn:active { opacity:.8; }
.pay-tap-btn {
  width:160px;height:160px;border-radius:50%;margin:16px auto;
  background:linear-gradient(135deg, rgba(3,218,198,.15), rgba(0,136,255,.15));
  border:3px solid var(--accent);display:flex;flex-direction:column;
  align-items:center;justify-content:center;cursor:pointer;
  transition:all .2s;position:relative;overflow:hidden;
}
.pay-tap-btn:active { transform:scale(.95);background:rgba(3,218,198,.25); }
.pay-tap-btn .tap-icon { font-size:48px; }
.pay-tap-btn .tap-label { font-size:14px;font-weight:700;color:var(--accent);margin-top:4px; }
.pay-tap-btn .tap-ripple {
  position:absolute;inset:0;border-radius:50%;border:2px solid var(--accent);
  animation:tapPulse 2s infinite;
}
@keyframes tapPulse { 0%{transform:scale(.8);opacity:.6} 100%{transform:scale(1.2);opacity:0} }
.pay-or { text-align:center;color:var(--fg-dim);font-size:13px;margin:12px 0; }
.pay-qr-section {
  background:var(--bg2);border:1px solid var(--border);border-radius:16px;
  padding:16px;text-align:center;margin:12px 0;
}
.pay-qr-section img { width:160px;height:160px;border-radius:8px;margin:8px 0; }
.pay-qr-section .pqs-label { font-size:13px;color:var(--fg-dim); }
.pay-addr {
  background:var(--bg-input);border:1px solid var(--border);border-radius:8px;
  padding:10px;font-family:monospace;font-size:11px;color:var(--fg-dim);
  word-break:break-all;margin:8px 0;cursor:pointer;text-align:center;
}
.pay-addr:active { background:var(--bg4); }
.pay-history { margin-top:20px; }
.pay-history .ph-title { font-size:14px;font-weight:600;color:var(--accent);margin-bottom:8px; }
.pay-tx {
  display:flex;align-items:center;gap:10px;padding:10px;
  background:var(--bg2);border:1px solid var(--border);border-radius:10px;margin-bottom:6px;
}
.pay-tx .ptx-icon { font-size:20px; }
.pay-tx .ptx-info { flex:1; }
.pay-tx .ptx-type { font-size:13px;font-weight:600; }
.pay-tx .ptx-time { font-size:11px;color:var(--fg-dim); }
.pay-tx .ptx-amount { font-size:14px;font-weight:600; }
.pay-tx .ptx-amount.sent { color:var(--red); }
.pay-tx .ptx-amount.received { color:var(--green); }
.pay-network-bar {
  display:flex;gap:6px;justify-content:center;margin:8px 0;
}
.pay-net-btn {
  padding:4px 10px;border:1px solid var(--border);border-radius:12px;
  background:var(--bg3);color:var(--fg-dim);font-size:11px;cursor:pointer;
}
 .pay-net-btn.active { background:var(--blue);color:#fff;border-color:var(--blue); }
 /* â”€â”€ QR METHOD TOGGLES â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
 .pay-qr-methods { display:flex;gap:8px;justify-content:center;margin:8px 0; }
 .pay-qr-btn { padding:6px 12px;border:1px solid var(--border);border-radius:12px;background:var(--bg3);color:var(--fg);font-size:12px;cursor:pointer; }
 .pay-qr-btn.active { background:var(--accent);color:#000;border-color:var(--accent); }
 /* â”€â”€ GOOGLE PAY â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.gpay-section {
  margin:16px 0;padding:16px;background:var(--bg2);border:1px solid var(--border);border-radius:16px;
}
.gpay-section .gpay-title { font-size:14px;font-weight:600;margin-bottom:4px;display:flex;align-items:center;gap:8px; }
.gpay-section .gpay-desc { font-size:12px;color:var(--fg-dim);margin-bottom:12px; }
.gpay-btn {
  width:100%;height:48px;border:none;border-radius:12px;cursor:pointer;
  background:#000;color:#fff;font-size:15px;font-weight:600;
  display:flex;align-items:center;justify-content:center;gap:8px;
  transition:opacity .15s;
}
.light .gpay-btn { background:#000; }
.gpay-btn:active { opacity:.8; }
.gpay-btn img { height:22px; }
.gpay-btn-outline {
  width:100%;height:48px;border:1px solid var(--border);border-radius:12px;cursor:pointer;
  background:transparent;color:var(--fg);font-size:14px;font-weight:600;
  display:flex;align-items:center;justify-content:center;gap:8px;
  margin-top:8px;transition:all .15s;
}
.gpay-btn-outline:active { background:var(--bg4); }
.gpay-badge {
  display:inline-flex;align-items:center;gap:4px;padding:4px 10px;
  background:rgba(3,218,198,.1);border:1px solid var(--accent);border-radius:8px;
  font-size:11px;color:var(--accent);font-weight:600;
}
.gpay-status {
  text-align:center;padding:8px;font-size:12px;color:var(--fg-dim);
  margin-top:8px;border-radius:8px;
}
.gpay-status.success { color:var(--green);background:rgba(0,230,118,.08); }
.gpay-status.error { color:var(--red);background:rgba(239,83,80,.08); }
/* â”€â”€ PAYMENT SERVICES (Netspend/CashApp/Venmo) â”€â”€ */
.pay-service-section {
  margin:16px 0;padding:16px;background:var(--bg2);border:1px solid var(--border);border-radius:16px;
}
.pay-service-section .pss-title { font-size:14px;font-weight:600;margin-bottom:4px;display:flex;align-items:center;gap:8px; }
.pay-service-section .pss-desc { font-size:12px;color:var(--fg-dim);margin-bottom:12px; }
.pay-svc-btn {
  width:100%;height:48px;border:none;border-radius:12px;cursor:pointer;
  font-size:15px;font-weight:600;display:flex;align-items:center;justify-content:center;gap:8px;
  transition:opacity .15s;margin-bottom:8px;
}
.pay-svc-btn:active { opacity:.8; }
.pay-svc-btn.netspend { background:#1a8b37;color:#fff; }
.pay-svc-btn.cashapp { background:#00d632;color:#000; }
.pay-svc-btn.venmo { background:#008cff;color:#fff; }
.pay-svc-input {
  width:100%;padding:10px 12px;background:var(--bg-input);color:var(--fg);
  border:1px solid var(--border);border-radius:8px;font-size:13px;margin-bottom:8px;
  font-family:inherit;outline:none;
}
.pay-svc-input:focus { border-color:var(--accent); }
.pay-svc-input::placeholder { color:var(--fg-dim); }
.pay-svc-linked {
  display:flex;align-items:center;gap:8px;padding:10px 12px;
  background:rgba(0,230,118,.06);border:1px solid rgba(0,230,118,.2);border-radius:10px;
  font-size:13px;color:var(--green);margin-bottom:8px;
}
.pay-svc-row { display:flex;gap:8px;margin-bottom:8px; }
.pay-svc-row button { flex:1; }
.pay-checkout-row { display:flex;gap:8px;margin:8px 0; }
.pay-checkout-row .pay-svc-btn { flex:1;margin:0;height:44px;font-size:13px;border-radius:10px; }
/* â”€â”€ FEE DISPLAY â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.fee-breakdown {
  background:var(--bg3);border:1px solid var(--border);border-radius:10px;
  padding:10px 14px;margin:8px 0;font-size:12px;
}
.fee-breakdown .fb-row { display:flex;justify-content:space-between;padding:2px 0; }
.fee-breakdown .fb-row.total { font-weight:700;font-size:13px;border-top:1px solid var(--border);margin-top:4px;padding-top:6px; }
.fee-breakdown .fb-label { color:var(--fg-dim); }
.fee-breakdown .fb-val { color:var(--fg); }
.fee-breakdown .fb-fee { color:var(--orange); }
/* â”€â”€ INCOME DASHBOARD â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.income-card {
  background:linear-gradient(135deg,#0a2e1a,#0e1a0e);border:1px solid rgba(0,230,118,.2);
  border-radius:16px;padding:20px;margin:16px 0;
}
.light .income-card { background:linear-gradient(135deg,#e0ffe0,#f0f5f0);border-color:rgba(0,230,118,.3); }
.income-card .ic-label { font-size:13px;color:var(--fg-dim); }
.income-card .ic-amount { font-size:32px;font-weight:700;color:var(--green);margin:4px 0; }
.income-card .ic-sub { font-size:12px;color:var(--fg-dim); }
.income-card .ic-row { display:flex;gap:12px;margin-top:12px; }
.income-card .ic-stat {
  flex:1;background:rgba(255,255,255,.04);border-radius:10px;padding:10px;text-align:center;
}
.income-card .ic-stat-val { font-size:18px;font-weight:700;color:var(--fg); }
.income-card .ic-stat-label { font-size:11px;color:var(--fg-dim);margin-top:2px; }
.income-tx {
  display:flex;align-items:center;gap:10px;padding:8px 12px;
  border-bottom:1px solid var(--border);font-size:12px;
}
.income-tx .itx-method { font-weight:600;flex:1; }
.income-tx .itx-fee { color:var(--green);font-weight:600; }
.income-tx .itx-time { color:var(--fg-dim);font-size:11px; }
/* â”€â”€ QR / SHARE SCREEN â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.share-body { flex:1;overflow-y:auto;padding:24px;display:flex;flex-direction:column;align-items:center; }
.share-body .logo-big { width:80px;height:80px;border-radius:50%;margin-bottom:16px; }
.share-body h2 { font-size:20px;letter-spacing:3px;margin-bottom:4px; }
.share-body .sub { color:var(--accent);font-size:13px;letter-spacing:2px;margin-bottom:24px; }
.qr-box {
  background:#fff;padding:16px;border-radius:16px;margin-bottom:20px;
}
.qr-box img { width:200px;height:200px;image-rendering:pixelated; }
.share-label { font-size:14px;font-weight:600;margin-bottom:4px; }
.share-desc { font-size:12px;color:var(--fg-dim);text-align:center;max-width:280px;margin-bottom:20px; }
.share-btn {
  width:100%;max-width:280px;padding:14px;border:none;border-radius:12px;
  background:var(--accent);color:#000;font-size:15px;font-weight:700;cursor:pointer;
  margin-bottom:10px;
}
.share-btn:active { background:#04f0d8; }
.share-btn.outline {
  background:transparent;border:1px solid var(--accent);color:var(--accent);
}
/* â”€â”€ SUBZERO PAY P2P â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.szpay-body { flex:1;overflow-y:auto;padding:16px; }
.szpay-hero { text-align:center;padding:20px 0 10px; }
.szpay-hero .szp-icon { font-size:48px;margin-bottom:8px; }
.szpay-hero .szp-title { font-size:22px;font-weight:800;color:var(--accent);letter-spacing:1px; }
.szpay-hero .szp-sub { font-size:13px;color:var(--fg-dim);margin-top:4px; }
.szpay-modes { display:flex;gap:10px;margin:16px 0; }
.szpay-mode-btn {
  flex:1;padding:18px 10px;border:2px solid var(--border);border-radius:16px;
  background:var(--bg3);color:var(--fg);text-align:center;cursor:pointer;transition:all .2s;
}
.szpay-mode-btn.active { border-color:var(--accent);background:rgba(3,218,198,.1); }
.szpay-mode-btn .smb-icon { font-size:32px;display:block;margin-bottom:6px; }
.szpay-mode-btn .smb-label { font-size:14px;font-weight:700; }
.szpay-mode-btn .smb-desc { font-size:11px;color:var(--fg-dim);margin-top:2px; }
.szpay-form { background:var(--bg3);border:1px solid var(--border);border-radius:16px;padding:16px;margin-bottom:14px; }
.szpay-form label { font-size:12px;color:var(--fg-dim);display:block;margin-bottom:4px;font-weight:600; }
.szpay-form input, .szpay-form textarea {
  width:100%;background:var(--bg-input);color:var(--fg);border:1px solid var(--border);
  border-radius:10px;padding:10px 14px;font-size:15px;outline:none;margin-bottom:10px;
}
.szpay-form input:focus, .szpay-form textarea:focus { border-color:var(--accent); }
.szpay-form textarea { resize:none;height:44px;font-size:13px; }
.szpay-route-btns { display:flex;gap:6px;margin-bottom:12px;flex-wrap:wrap; }
.szpay-route-btn {
  padding:8px 14px;border:1px solid var(--border);border-radius:20px;
  background:var(--bg3);color:var(--fg);font-size:12px;cursor:pointer;font-weight:600;
}
.szpay-route-btn.active { background:var(--accent);color:#000;border-color:var(--accent); }
.szpay-fee-box {
  background:var(--bg4);border-radius:10px;padding:10px 14px;margin-bottom:12px;font-size:13px;
}
.szpay-fee-box .sfb-row { display:flex;justify-content:space-between;margin-bottom:4px; }
.szpay-fee-box .sfb-row.total { border-top:1px solid var(--border);padding-top:6px;margin-top:4px;font-weight:700;color:var(--accent); }
.szpay-fee-box .sfb-label { color:var(--fg-dim); }
.szpay-fee-box .sfb-fee { color:var(--orange); }
.szpay-generate-btn {
  width:100%;padding:16px;border:none;border-radius:14px;
  background:var(--accent);color:#000;font-size:16px;font-weight:800;cursor:pointer;
  letter-spacing:.5px;
}
.szpay-generate-btn:active { background:#04f0d8; }
.szpay-qr-result {
  text-align:center;padding:20px 0;
}
.szpay-qr-result img { width:220px;height:220px;border-radius:12px;border:3px solid var(--accent); }
.szpay-qr-result .sqr-amount { font-size:28px;font-weight:800;color:var(--accent);margin:12px 0 4px; }
.szpay-qr-result .sqr-fee { font-size:12px;color:var(--orange); }
.szpay-qr-result .sqr-note { font-size:13px;color:var(--fg-dim);margin-top:4px; }
.szpay-qr-result .sqr-route { font-size:13px;color:var(--fg);margin-top:6px;font-weight:600; }
.szpay-scan-btn {
  width:100%;padding:16px;border:2px solid var(--accent);border-radius:14px;
  background:transparent;color:var(--accent);font-size:16px;font-weight:800;cursor:pointer;
  margin-top:10px;
}
.szpay-scan-btn:active { background:rgba(3,218,198,.1); }
.szpay-wallet { background:var(--bg3);border:1px solid var(--border);border-radius:16px;padding:14px;margin-bottom:16px; }
.szpay-wallet .spw-title { font-size:14px;font-weight:700;color:var(--accent);margin-bottom:10px;display:flex;align-items:center;gap:8px; }
.szpay-wallet .spw-linked { display:flex;flex-direction:column;gap:6px;margin-bottom:10px; }
.spw-card {
  display:flex;align-items:center;gap:10px;padding:10px 12px;background:var(--bg4);border-radius:12px;
  border:1px solid var(--border);font-size:13px;
}
.spw-card .spwc-icon { font-size:22px;width:28px;text-align:center; }
.spw-card .spwc-info { flex:1; }
.spw-card .spwc-name { font-weight:600; }
.spw-card .spwc-detail { font-size:11px;color:var(--fg-dim); }
.spw-card .spwc-remove { background:none;border:none;color:var(--red);font-size:16px;cursor:pointer;padding:4px; }
.spw-card.default { border-color:var(--accent); }
.spw-card .spwc-default { font-size:10px;color:var(--accent);font-weight:700; }
.spw-add-card { background:var(--bg4);border:1px dashed var(--border);border-radius:12px;padding:12px;margin-bottom:8px; }
.spw-add-card label { font-size:11px;color:var(--fg-dim);display:block;margin-bottom:3px;font-weight:600; }
.spw-add-card input {
  width:100%;background:var(--bg-input);color:var(--fg);border:1px solid var(--border);
  border-radius:8px;padding:8px 10px;font-size:14px;outline:none;margin-bottom:6px;
}
.spw-add-card input:focus { border-color:var(--accent); }
.spw-add-card .spw-card-row { display:flex;gap:6px; }
.spw-add-card .spw-card-row input { flex:1; }
.spw-add-btn {
  width:100%;padding:10px;border:none;border-radius:10px;font-size:13px;font-weight:700;
  cursor:pointer;margin-bottom:4px;
}
.spw-add-btn.primary { background:var(--accent);color:#000; }
.spw-add-btn.outline { background:transparent;border:1px solid var(--border);color:var(--fg); }
.spw-quick-links { display:flex;flex-wrap:wrap;gap:6px;margin-top:8px; }
.spw-quick-link {
  padding:8px 12px;border:1px solid var(--border);border-radius:20px;
  background:var(--bg3);color:var(--fg);font-size:12px;cursor:pointer;font-weight:600;
}
.spw-quick-link:active { background:var(--bg4); }
.szpay-history { margin-top:16px; }
.szpay-history .sph-title { font-size:14px;font-weight:700;color:var(--accent);margin-bottom:8px; }
.szpay-tx { display:flex;align-items:center;gap:10px;padding:10px 12px;border-bottom:1px solid var(--border); }
.szpay-tx .spt-icon { font-size:24px; }
.szpay-tx .spt-info { flex:1; }
.szpay-tx .spt-method { font-size:13px;font-weight:600; }
.szpay-tx .spt-time { font-size:11px;color:var(--fg-dim); }
.szpay-tx .spt-amount { font-size:14px;font-weight:700; }
.szpay-tx .spt-amount.sent { color:var(--red); }
.szpay-tx .spt-amount.received { color:var(--green); }
/* â”€â”€ CONTACTS SCREEN â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.contacts-body { flex:1;overflow-y:auto;padding:0; }
.contacts-toolbar {
  display:flex;gap:8px;padding:10px 12px;background:var(--bg2);border-bottom:1px solid var(--border);
  position:sticky;top:0;z-index:5;
}
.contacts-toolbar input {
  flex:1;background:var(--bg-input);color:var(--fg);border:1px solid var(--border);
  border-radius:20px;padding:8px 16px;font-size:14px;outline:none;
}
.contacts-toolbar input:focus { border-color:var(--accent); }
.contacts-toolbar button {
  background:var(--accent);color:#000;border:none;border-radius:20px;
  padding:8px 14px;font-size:13px;font-weight:700;cursor:pointer;white-space:nowrap;
}
.contacts-toolbar button:active { background:#04f0d8; }
.contact-section-header {
  padding:6px 16px;background:var(--bg3);font-size:12px;font-weight:700;color:var(--accent);
  text-transform:uppercase;letter-spacing:1px;border-bottom:1px solid var(--border);
}
.contact-item {
  display:flex;align-items:center;gap:12px;padding:12px 16px;cursor:pointer;
  border-bottom:1px solid var(--border);
}
.contact-item:active { background:var(--bg4); }
.contact-avatar {
  width:44px;height:44px;border-radius:50%;display:flex;align-items:center;justify-content:center;
  font-size:18px;font-weight:700;color:#fff;flex-shrink:0;
}
.contact-info { flex:1;min-width:0; }
.contact-name { font-size:15px;font-weight:600;white-space:nowrap;overflow:hidden;text-overflow:ellipsis; }
.contact-detail { font-size:12px;color:var(--fg-dim);white-space:nowrap;overflow:hidden;text-overflow:ellipsis; }
.contact-actions { display:flex;gap:6px; }
.contact-action-btn {
  width:36px;height:36px;border:1px solid var(--border);border-radius:50%;
  background:var(--bg3);color:var(--fg);font-size:16px;cursor:pointer;
  display:flex;align-items:center;justify-content:center;
}
.contact-action-btn:active { background:var(--bg4); }
.contact-action-btn.pay { border-color:var(--accent);color:var(--accent); }
.contact-empty {
  text-align:center;padding:40px 20px;color:var(--fg-dim);
}
.contact-empty .ce-icon { font-size:56px;margin-bottom:12px; }
.contact-empty .ce-title { font-size:16px;font-weight:600;color:var(--fg);margin-bottom:6px; }
.contact-empty .ce-sub { font-size:13px; }
.contact-stats {
  display:flex;gap:8px;padding:12px 16px;background:var(--bg2);border-bottom:1px solid var(--border);
}
.contact-stat {
  flex:1;text-align:center;background:var(--bg3);border-radius:10px;padding:10px 8px;
}
.contact-stat .cs-val { font-size:20px;font-weight:800;color:var(--accent); }
.contact-stat .cs-label { font-size:10px;color:var(--fg-dim);margin-top:2px; }
/* Contact modal */
.contact-modal {
  display:none;position:fixed;inset:0;background:rgba(0,0,0,.7);z-index:200;
  align-items:center;justify-content:center;padding:20px;
}
.contact-modal.open { display:flex; }
.contact-modal-box {
  background:var(--bg2);border:1px solid var(--border);border-radius:16px;
  padding:20px;width:100%;max-width:360px;
}
.contact-modal-box h3 { font-size:16px;margin-bottom:14px;color:var(--accent); }
.contact-modal-box label { font-size:11px;color:var(--fg-dim);display:block;margin-bottom:3px;font-weight:600; }
.contact-modal-box input {
  width:100%;background:var(--bg-input);color:var(--fg);border:1px solid var(--border);
  border-radius:10px;padding:10px 12px;font-size:14px;outline:none;margin-bottom:10px;
}
.contact-modal-box input:focus { border-color:var(--accent); }
.cm-btns { display:flex;gap:8px;margin-top:6px; }
.cm-btn {
  flex:1;padding:12px;border:none;border-radius:10px;font-size:14px;font-weight:700;cursor:pointer;
}
.cm-btn.primary { background:var(--accent);color:#000; }
.cm-btn.cancel { background:var(--bg4);color:var(--fg); }
.cm-btn.danger { background:var(--red);color:#fff; }
.contacts-footer {
  padding:12px 16px;border-top:1px solid var(--border);display:flex;gap:8px;
}
.contacts-footer button {
  flex:1;padding:10px;border:1px solid var(--border);border-radius:10px;
  background:var(--bg3);color:var(--fg);font-size:12px;font-weight:600;cursor:pointer;
}
.contacts-footer button:active { background:var(--bg4); }
/* â”€â”€ SUBZERO MAIL SCREEN â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.szmail-body { flex:1;overflow-y:auto;padding:16px; }
.szmail-hero { text-align:center;padding:16px 0 10px; }
.szmail-hero .szm-icon { font-size:48px;margin-bottom:8px; }
.szmail-hero .szm-title { font-size:22px;font-weight:800;color:var(--accent);letter-spacing:1px; }
.szmail-hero .szm-sub { font-size:13px;color:var(--fg-dim);margin-top:4px; }
.szmail-setup {
  background:var(--bg3);border:1px solid var(--border);border-radius:16px;padding:16px;margin-bottom:16px;
}
.szmail-setup label { font-size:12px;color:var(--fg-dim);display:block;margin-bottom:4px;font-weight:600; }
.szmail-setup input {
  width:100%;background:var(--bg-input);color:var(--fg);border:1px solid var(--border);
  border-radius:10px;padding:10px 14px;font-size:15px;outline:none;margin-bottom:10px;
}
.szmail-setup input:focus { border-color:var(--accent); }
.szmail-linked {
  display:flex;align-items:center;gap:10px;padding:12px;background:var(--bg4);
  border-radius:12px;border:1px solid var(--accent);margin-bottom:10px;
}
.szmail-linked .szml-icon { font-size:24px; }
.szmail-linked .szml-info { flex:1; }
.szmail-linked .szml-addr { font-size:15px;font-weight:700;color:var(--accent); }
.szmail-linked .szml-label { font-size:11px;color:var(--fg-dim); }
.szmail-linked .szml-edit {
  background:none;border:1px solid var(--border);color:var(--fg);border-radius:8px;
  padding:6px 10px;font-size:12px;cursor:pointer;
}
.szmail-qr-section {
  text-align:center;background:var(--bg3);border:1px solid var(--border);
  border-radius:16px;padding:20px;margin-bottom:16px;
}
.szmail-qr-section .sqr-title { font-size:14px;font-weight:700;color:var(--accent);margin-bottom:10px; }
.szmail-qr-section img { width:200px;height:200px;border-radius:12px;border:3px solid var(--accent);margin-bottom:10px; }
.szmail-qr-section .sqr-addr { font-size:13px;color:var(--fg);font-weight:600;word-break:break-all; }
.szmail-qr-section .sqr-hint { font-size:11px;color:var(--fg-dim);margin-top:6px; }
.szmail-actions { display:flex;gap:8px;margin-bottom:16px; }
.szmail-action-btn {
  flex:1;padding:14px 10px;border:2px solid var(--border);border-radius:14px;
  background:var(--bg3);color:var(--fg);text-align:center;cursor:pointer;
}
.szmail-action-btn:active { background:var(--bg4); }
.szmail-action-btn .sma-icon { font-size:28px;display:block;margin-bottom:4px; }
.szmail-action-btn .sma-label { font-size:12px;font-weight:700; }
.szmail-send-section {
  background:var(--bg3);border:1px solid var(--border);border-radius:16px;padding:16px;margin-bottom:16px;
}
.szmail-send-section .sms-title { font-size:14px;font-weight:700;color:var(--accent);margin-bottom:10px; }
.szmail-send-section label { font-size:12px;color:var(--fg-dim);display:block;margin-bottom:4px;font-weight:600; }
.szmail-send-section input, .szmail-send-section select {
  width:100%;background:var(--bg-input);color:var(--fg);border:1px solid var(--border);
  border-radius:10px;padding:10px 14px;font-size:14px;outline:none;margin-bottom:10px;
}
.szmail-send-section input:focus, .szmail-send-section select:focus { border-color:var(--accent); }
.szmail-send-btn {
  width:100%;padding:14px;border:none;border-radius:12px;
  background:var(--accent);color:#000;font-size:15px;font-weight:800;cursor:pointer;
}
.szmail-send-btn:active { background:#04f0d8; }
.szmail-tx { display:flex;align-items:center;gap:10px;padding:10px 12px;border-bottom:1px solid var(--border); }
.szmail-tx .smt-icon { font-size:22px; }
.szmail-tx .smt-info { flex:1; }
.szmail-tx .smt-to { font-size:13px;font-weight:600; }
.szmail-tx .smt-time { font-size:11px;color:var(--fg-dim); }
.szmail-tx .smt-amount { font-size:14px;font-weight:700; }
.szmail-tx .smt-amount.sent { color:var(--red); }
.szmail-tx .smt-amount.received { color:var(--green); }
/* â”€â”€ INSTRUCTIONS SCREEN â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.instructions-body { flex:1;overflow-y:auto;padding:20px; }
.inst-step {
  display:flex;gap:12px;margin-bottom:20px;
}
.inst-num {
  width:28px;height:28px;border-radius:50%;background:var(--accent);color:#000;
  font-size:14px;font-weight:700;display:flex;align-items:center;justify-content:center;flex-shrink:0;
}
.inst-text { font-size:14px;line-height:1.5; }
.inst-text b { color:var(--accent); }
/* â”€â”€ ATTACH MENU â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.attach-menu {
  display:none;position:fixed;bottom:60px;left:8px;right:8px;
  background:var(--bg2);border:1px solid var(--border);border-radius:16px;
  padding:16px;z-index:60;
}
.attach-menu.open { display:block; }
.attach-grid { display:grid;grid-template-columns:repeat(4,1fr);gap:12px; }
.attach-option {
  display:flex;flex-direction:column;align-items:center;gap:6px;cursor:pointer;padding:8px;
}
.attach-option .ao-icon {
  width:48px;height:48px;border-radius:50%;display:flex;align-items:center;justify-content:center;
  font-size:22px;
}
.attach-option .ao-label { font-size:11px;color:var(--fg-dim); }
/* â”€â”€ SEARCH BAR â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
/* â”€â”€ SCANNER OVERLAY â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
#scanOverlay{position:fixed;inset:0;background:rgba(0,0,0,.9);display:none;flex-direction:column;align-items:center;justify-content:center;z-index:1000}
#scanOverlay.open{display:flex}
#scanVideo{width:90vw;max-width:420px;border-radius:14px;border:2px solid var(--accent);}
#scanHint{color:var(--accent);font-size:14px;margin-top:8px}
#scanClose{position:absolute;top:12px;right:12px;background:transparent;border:1px solid var(--border);color:var(--fg);border-radius:10px;padding:8px 10px;}
/* â”€â”€ SEARCH BAR â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.search-bar {
  display:none;padding:8px;background:var(--bg2);border-bottom:1px solid var(--border);
}
.search-bar.open { display:flex;gap:8px;align-items:center; }
.search-bar input {
  flex:1;background:var(--bg-input);color:var(--fg);border:1px solid var(--border);
  border-radius:20px;padding:8px 16px;font-size:14px;outline:none;
}
.search-bar input:focus { border-color:var(--accent); }
.search-bar .search-close { background:none;border:none;color:var(--fg-dim);font-size:20px;cursor:pointer; }
/* â”€â”€ INSTALL BANNER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.install-banner {
  display:none;padding:12px 16px;background:var(--bg3);border-bottom:1px solid var(--border);
  align-items:center;gap:12px;
}
.install-banner.show { display:flex; }
.install-banner img { width:40px;height:40px;border-radius:10px; }
.install-banner .ib-text { flex:1;font-size:13px; }
.install-banner .ib-text b { display:block;font-size:14px; }
.install-banner .ib-btn {
  background:var(--accent);color:#000;border:none;border-radius:8px;
  padding:8px 16px;font-weight:700;font-size:13px;cursor:pointer;
}
.install-banner .ib-close { background:none;border:none;color:var(--fg-dim);font-size:18px;cursor:pointer; }
</style>
</head>
<body>

<!-- â•â•â•â•â•â•â• OVERLAY + DRAWER â•â•â•â•â•â•â• -->
<div class="overlay" id="overlay" onclick="closeDrawer()"></div>
<div class="drawer" id="drawer">
  <div class="drawer-header">
    <img src="icon-192.png" alt="Logo">
    <div class="dname">Sub-Zero</div>
    <div class="dsub">Flawless Victory</div>
  </div>
  <div class="drawer-items">
    <div class="drawer-item" onclick="showScreen('chat');closeDrawer()"><span class="di-icon">ğŸ’¬</span>Spine Rip Chat</div>
    <div class="drawer-item" onclick="showScreen('szpay');closeDrawer()"><span class="di-icon">ğŸ’¸</span>SubZero Pay</div>
    <div class="drawer-item" onclick="showScreen('contacts');closeDrawer()"><span class="di-icon">ğŸ‘¥</span>Contacts</div>
    <div class="drawer-item" onclick="showScreen('szmail');closeDrawer()"><span class="di-icon">ğŸ“§</span>SubZero Mail</div>
    <div class="drawer-item" onclick="showScreen('wallet');closeDrawer()"><span class="di-icon">ğŸ’°</span>Crypto Wallet</div>
    <div class="drawer-item" onclick="showScreen('share');closeDrawer()"><span class="di-icon">ğŸ“¥</span>Download Desktop</div>
    <div class="drawer-item" onclick="showScreen('instructions');closeDrawer()"><span class="di-icon">ğŸ“–</span>Instructions</div>
    <div class="drawer-sep"></div>
    <div class="drawer-item" onclick="showScreen('settings');closeDrawer()"><span class="di-icon">âš™ï¸</span>Settings</div>
    <div class="drawer-item" onclick="toggleTheme();closeDrawer()"><span class="di-icon" id="theme-icon">ğŸŒ™</span><span id="theme-label">Dark Theme</span></div>
    <div class="drawer-sep"></div>
    <div class="drawer-item" onclick="showScreen('share');closeDrawer()"><span class="di-icon">ğŸ‘¥</span>Invite Friends</div>
  </div>
  <div class="drawer-footer">SubZero v2.5 â€¢ Flawless Victory</div>
</div>

<!-- â•â•â•â•â•â•â• INSTALL BANNER â•â•â•â•â•â•â• -->
<div class="install-banner" id="installBanner">
  <img src="icon-192.png" alt="">
  <div class="ib-text"><b>SubZero</b>Install the app on your phone</div>
  <button class="ib-btn" onclick="installApp()">Install</button>
  <button class="ib-close" onclick="dismissInstall()">âœ•</button>
</div>

<!-- â•â•â•â•â•â•â• HOME SCREEN â•â•â•â•â•â•â• -->
<div class="screen active" id="screen-home">
  <div class="home-header">
    <button class="hamburger" onclick="openDrawer()">â˜°</button>
    <div class="title">SubZero</div>
    <button class="search-btn" onclick="toggleSearch()">ğŸ”</button>
  </div>
  <div class="search-bar" id="homeSearch">
    <input type="text" placeholder="Search..." id="searchInput" oninput="filterChats()">
    <button class="search-close" onclick="toggleSearch()">âœ•</button>
  </div>
  <div class="chat-list" id="chatList">
    <div class="chat-card" onclick="showScreen('chat')">
      <img src="icon-192.png" alt="">
      <div class="cc-info">
        <div class="cc-top">
          <span class="cc-name">Spine Rip</span>
          <span class="cc-time" id="lastTime">now</span>
        </div>
        <div class="cc-preview" id="lastPreview">Tap to start chatting...</div>
      </div>
    </div>
    <div class="chat-card" onclick="showScreen('wallet')">
      <div style="width:52px;height:52px;border-radius:50%;background:linear-gradient(135deg,#f7931a,#ff6b00);display:flex;align-items:center;justify-content:center;font-size:24px;">â‚¿</div>
      <div class="cc-info">
        <div class="cc-top">
          <span class="cc-name">Crypto Wallet</span>
          <span class="cc-time">â€”</span>
        </div>
        <div class="cc-preview">View balances & connect wallets</div>
      </div>
    </div>
    <div class="chat-card" onclick="showScreen('szpay')">
      <div style="width:52px;height:52px;border-radius:50%;background:linear-gradient(135deg,#03dac6,#00b894);display:flex;align-items:center;justify-content:center;font-size:24px;">ğŸ’¸</div>
      <div class="cc-info">
        <div class="cc-top">
          <span class="cc-name">SubZero Pay</span>
          <span class="cc-time">P2P</span>
        </div>
        <div class="cc-preview">Send & receive payments via QR code</div>
      </div>
    </div>
    <div class="chat-card" onclick="showScreen('szmail')">
      <div style="width:52px;height:52px;border-radius:50%;background:linear-gradient(135deg,#00b4d8,#0077b6);display:flex;align-items:center;justify-content:center;font-size:24px;">ğŸ“§</div>
      <div class="cc-info">
        <div class="cc-top">
          <span class="cc-name">SubZero Mail</span>
          <span class="cc-time">QR</span>
        </div>
        <div class="cc-preview">Email QR codes & stablecoin transfers</div>
      </div>
    </div>
    <div class="chat-card" onclick="showScreen('contacts')">
      <div style="width:52px;height:52px;border-radius:50%;background:linear-gradient(135deg,#bb86fc,#7c4dff);display:flex;align-items:center;justify-content:center;font-size:24px;">ğŸ‘¥</div>
      <div class="cc-info">
        <div class="cc-top">
          <span class="cc-name">Contacts</span>
          <span class="cc-time" id="contactCount">0</span>
        </div>
        <div class="cc-preview">Import, manage & pay your contacts</div>
      </div>
    </div>
  </div>
  <button class="fab" onclick="showScreen('chat')">âœï¸</button>
</div>

<!-- â•â•â•â•â•â•â• SUBZERO PAY P2P SCREEN â•â•â•â•â•â•â• -->
<div class="screen" id="screen-szpay">
  <div class="header">
    <button class="back" onclick="showScreen('home')">â†</button>
    <div class="info"><div class="name">SubZero Pay</div><div class="status">Peer-to-Peer â€¢ QR Payments</div></div>
  </div>
  <div class="szpay-body">
    <div class="szpay-hero">
      <div class="szp-icon">ğŸ’¸</div>
      <div class="szp-title">SubZero Pay</div>
      <div class="szp-sub">Two-way payments between SubZero users</div>
    </div>

    <!-- Mode Toggle -->
    <div class="szpay-modes">
      <div class="szpay-mode-btn active" id="szpModeRequest" onclick="setSZPayMode('request')">
        <span class="smb-icon">ğŸ“²</span>
        <span class="smb-label">Request</span>
        <span class="smb-desc">Generate a payment QR</span>
      </div>
      <div class="szpay-mode-btn" id="szpModeScan" onclick="setSZPayMode('scan')">
        <span class="smb-icon">ğŸ“·</span>
        <span class="smb-label">Scan & Pay</span>
        <span class="smb-desc">Scan someone's QR to pay</span>
      </div>
    </div>

    <!-- REQUEST MODE: Form -->
    <div id="szpRequestPanel">
      <div class="szpay-form">
        <label>Amount ($)</label>
        <input type="number" id="szpAmount" placeholder="0.00" step="0.01" min="0.01" oninput="updateSZPFee()">

        <label>Payment Route</label>
        <div class="szpay-route-btns">
          <div class="szpay-route-btn active" onclick="setSZPRoute('cashapp',this)">ğŸ’² Cash App</div>
          <div class="szpay-route-btn" onclick="setSZPRoute('venmo',this)">â“‹ Venmo</div>
          <div class="szpay-route-btn" onclick="setSZPRoute('card',this)">ğŸ’³ Card</div>
          <div class="szpay-route-btn" onclick="setSZPRoute('googlepay',this)">ğŸ”· Google Pay</div>
          <div class="szpay-route-btn" onclick="setSZPRoute('mercadopago',this)">ğŸŸ¢ Mercado Pago</div>
          <div class="szpay-route-btn" onclick="setSZPRoute('phonepe',this)">ğŸ“± PhonePe</div>
          <div class="szpay-route-btn" onclick="setSZPRoute('wechat',this)">ğŸ’¬ WeChat Pay</div>
          <div class="szpay-route-btn" onclick="setSZPRoute('crypto',this)">ğŸª™ Crypto</div>
        </div>

        <label>Note (optional)</label>
        <textarea id="szpNote" placeholder="What's this payment for?"></textarea>
      </div>

      <!-- Fee Breakdown -->
      <div class="szpay-fee-box" id="szpFeeBox" style="display:none">
        <div class="sfb-row"><span class="sfb-label">Amount</span><span id="szpFeeAmt">$0.00</span></div>
        <div class="sfb-row"><span class="sfb-label sfb-fee">SubZero Fee (2.9% + $0.30)</span><span class="sfb-fee" id="szpFeeFee">$0.00</span></div>
        <div class="sfb-row total"><span class="sfb-label">Total Payer Pays</span><span id="szpFeeTotal">$0.00</span></div>
      </div>

      <button class="szpay-generate-btn" onclick="generateSZPayQR()">Generate Payment QR Code</button>

      <!-- Generated QR Result -->
      <div class="szpay-qr-result" id="szpQRResult" style="display:none">
        <div style="font-size:14px;font-weight:700;margin-bottom:8px;">Show this to the payer â†“</div>
        <img id="szpQRImg" src="" alt="SubZero Pay QR">
        <div class="sqr-amount" id="szpQRAmount"></div>
        <div class="sqr-fee" id="szpQRFee"></div>
        <div class="sqr-route" id="szpQRRoute"></div>
        <div class="sqr-note" id="szpQRNote"></div>
        <button class="szpay-scan-btn" style="margin-top:16px" onclick="shareSZPayQR()">ğŸ“¤ Share QR Code</button>
      </div>
    </div>

    <!-- LINKED PAYMENT METHODS -->
    <div class="szpay-wallet" id="szpWalletSection">
      <div class="spw-title">ğŸ’³ My Payment Methods</div>
      <div class="spw-linked" id="spwLinkedList">
        <!-- Populated by JS -->
      </div>

      <!-- Add Card Form (collapsed by default) -->
      <div class="spw-add-card" id="spwAddCardForm" style="display:none">
        <label>Card Number</label>
        <input type="text" id="spwCardNum" placeholder="1234 5678 9012 3456" maxlength="19" oninput="formatCardNum(this)">
        <div class="spw-card-row">
          <div style="flex:1"><label>Expiry</label><input type="text" id="spwCardExp" placeholder="MM/YY" maxlength="5" oninput="formatCardExp(this)"></div>
          <div style="flex:1"><label>CVV</label><input type="password" id="spwCardCVV" placeholder="â€¢â€¢â€¢" maxlength="4"></div>
        </div>
        <label>Name on Card</label>
        <input type="text" id="spwCardName" placeholder="John Doe">
        <button class="spw-add-btn primary" onclick="saveLinkedCard()">Save Card</button>
        <div style="font-size:10px;color:var(--fg-dim);text-align:center;margin-top:4px;">ğŸ”’ Card info is stored locally on your device only. Never sent to any server.</div>
      </div>

      <button class="spw-add-btn outline" onclick="toggleAddCard()">â• Add Debit / Credit Card</button>

      <div class="spw-quick-links">
        <div class="spw-quick-link" onclick="linkQuickMethod('cashapp')">ğŸ’² Cash App</div>
        <div class="spw-quick-link" onclick="linkQuickMethod('venmo')">â“‹ Venmo</div>
        <div class="spw-quick-link" onclick="linkQuickMethod('googlepay')">ğŸ”· Google Pay</div>
        <div class="spw-quick-link" onclick="linkQuickMethod('mercadopago')">ğŸŸ¢ Mercado Pago</div>
        <div class="spw-quick-link" onclick="linkQuickMethod('phonepe')">ğŸ“± PhonePe</div>
        <div class="spw-quick-link" onclick="linkQuickMethod('wechat')">ğŸ’¬ WeChat Pay</div>
      </div>
    </div>

    <!-- SCAN MODE: Scanner -->
    <div id="szpScanPanel" style="display:none">
      <div style="text-align:center;padding:20px 0;">
        <div style="font-size:48px;margin-bottom:12px;">ğŸ“·</div>
        <div style="font-size:15px;font-weight:600;margin-bottom:8px;">Scan a SubZero Pay QR Code</div>
        <div style="font-size:13px;color:var(--fg-dim);margin-bottom:12px;">Point your camera at another user's payment QR to send them money.</div>
        <div style="font-size:12px;color:var(--fg-dim);margin-bottom:16px;">Payment will be charged to your <b style="color:var(--accent)" id="szpDefaultMethod">linked method</b>.</div>
        <button class="szpay-generate-btn" onclick="startSZPayScan()">ğŸ“¸ Open Camera & Scan</button>
        <div style="margin-top:16px;font-size:12px;color:var(--fg-dim);">A processing fee of <span style="color:var(--orange);font-weight:700;">2.9% + $0.30</span> is included in every transaction.</div>
      </div>
    </div>

    <!-- P2P Transaction History -->
    <div class="szpay-history">
      <div class="sph-title">SubZero Pay History</div>
      <div id="szpTxList">
        <div style="text-align:center;color:var(--fg-dim);font-size:13px;padding:20px;">No SubZero Pay transactions yet.<br>Request or scan to get started!</div>
      </div>
    </div>
  </div>
</div>

<!-- â•â•â•â•â•â•â• SUBZERO MAIL SCREEN â•â•â•â•â•â•â• -->
<div class="screen" id="screen-szmail">
  <div class="header">
    <button class="back" onclick="showScreen('home')">â†</button>
    <div class="info"><div class="name">SubZero Mail</div><div class="status">Email â€¢ QR Sharing â€¢ Stablecoins</div></div>
  </div>
  <div class="szmail-body">
    <div class="szmail-hero">
      <div class="szm-icon">ğŸ“§</div>
      <div class="szm-title">SubZero Mail</div>
      <div class="szm-sub">Share your email via QR â€¢ Send crypto to emails</div>
      <div style="margin-top:8px;font-size:12px;color:var(--fg-dim);">ğŸ’° A service fee of <span style="color:var(--orange);font-weight:700;">2.9% + $0.30</span> applies to all transfers</div>
    </div>

    <!-- Email Setup / Linked -->
    <div id="szmailLinkedSection" style="display:none">
      <div class="szmail-linked">
        <div class="szml-icon">âœ‰ï¸</div>
        <div class="szml-info">
          <div class="szml-addr" id="szmailAddr">you@subzero.xyz</div>
          <div class="szml-label">Linked email address</div>
        </div>
        <button class="szml-edit" onclick="editSZMail()">âœï¸ Edit</button>
      </div>
    </div>

    <div class="szmail-setup" id="szmailSetupSection">
      <label>Your Email Address</label>
      <input type="email" id="szmailInput" placeholder="you@subzero.xyz">
      <label>Display Name</label>
      <input type="text" id="szmailName" placeholder="Your Name">
      <label>Crypto Wallet Address (for receiving stablecoins)</label>
      <input type="text" id="szmailWallet" placeholder="0x... or SOL address">
      <button class="szmail-send-btn" onclick="saveSZMail()">Link Email Address</button>
    </div>

    <!-- My Email QR Code -->
    <div class="szmail-qr-section" id="szmailQRSection" style="display:none">
      <div class="sqr-title">ğŸ“± My Email QR Code</div>
      <img id="szmailQRImg" src="" alt="Email QR">
      <div class="sqr-addr" id="szmailQRAddr"></div>
      <div class="sqr-hint">Show this QR to share your email â€¢ Others scan to add you</div>
    </div>

    <!-- Quick Actions -->
    <div class="szmail-actions" id="szmailActions" style="display:none">
      <div class="szmail-action-btn" onclick="shareSZMailQR()">
        <span class="sma-icon">ğŸ“¤</span>
        <span class="sma-label">Share QR</span>
      </div>
      <div class="szmail-action-btn" onclick="scanEmailQR()">
        <span class="sma-icon">ğŸ“·</span>
        <span class="sma-label">Scan Email QR</span>
      </div>
      <div class="szmail-action-btn" onclick="copyEmailAddr()">
        <span class="sma-icon">ğŸ“‹</span>
        <span class="sma-label">Copy Email</span>
      </div>
    </div>

    <!-- Send Stablecoins to Email -->
    <div class="szmail-send-section" id="szmailSendSection" style="display:none">
      <div class="sms-title">ğŸª™ Send Stablecoins to Email</div>
      <label>Recipient Email</label>
      <input type="email" id="szmSendTo" placeholder="friend@subzero.xyz">
      <label>Amount (USD)</label>
      <input type="number" id="szmSendAmount" placeholder="0.00" step="0.01" min="0.01" oninput="updateSZMailFee()">
      <label>Stablecoin</label>
      <select id="szmSendCoin">
        <option value="USDT">USDT (Tether)</option>
        <option value="USDC">USDC (Circle)</option>
        <option value="DAI">DAI</option>
        <option value="BUSD">BUSD</option>
      </select>
      <label>Note (optional)</label>
      <input type="text" id="szmSendNote" placeholder="What's this for?">
      <!-- Fee breakdown -->
      <div class="szpay-fee-box" id="szmFeeBox" style="display:none;margin-bottom:10px;">
        <div class="sfb-row"><span class="sfb-label">Amount</span><span id="szmFeeAmt">$0.00</span></div>
        <div class="sfb-row"><span class="sfb-label sfb-fee">SubZero Fee (2.9% + $0.30)</span><span class="sfb-fee" id="szmFeeFee">$0.00</span></div>
        <div class="sfb-row total"><span class="sfb-label">Total Charged</span><span id="szmFeeTotal">$0.00</span></div>
      </div>
      <button class="szmail-send-btn" onclick="sendCoinToEmail()">ğŸš€ Generate Transfer QR</button>
      <div id="szmSendResult" style="display:none;text-align:center;margin-top:12px;">
        <img id="szmSendQRImg" src="" alt="Transfer QR" style="width:180px;height:180px;border-radius:10px;border:2px solid var(--accent);">
        <div style="font-size:12px;color:var(--fg-dim);margin-top:6px;">Recipient scans this QR to claim the transfer</div>
      </div>
    </div>

    <!-- Email Transfer History -->
    <div id="szmailHistory" style="display:none">
      <div style="font-size:14px;font-weight:700;color:var(--accent);margin-bottom:8px;">ğŸ“¨ Transfer History</div>
      <div id="szmailTxList"></div>
    </div>
  </div>
</div>

<!-- â•â•â•â•â•â•â• CONTACTS SCREEN â•â•â•â•â•â•â• -->
<div class="screen" id="screen-contacts">
  <div class="header">
    <button class="back" onclick="showScreen('home')">â†</button>
    <div class="info"><div class="name">Contacts</div><div class="status" id="contactStatusBar">0 contacts</div></div>
    <button class="hbtn" onclick="openAddContact()">ï¼‹</button>
  </div>
  <div class="contacts-body">
    <div class="contacts-toolbar">
      <input type="text" id="contactSearchInput" placeholder="Search contacts..." oninput="filterContacts()">
      <button onclick="importPhoneContacts()">ğŸ“± Import</button>
    </div>
    <div class="contact-stats">
      <div class="contact-stat"><div class="cs-val" id="csTotal">0</div><div class="cs-label">Total</div></div>
      <div class="contact-stat"><div class="cs-val" id="csPhone">0</div><div class="cs-label">Phone</div></div>
      <div class="contact-stat"><div class="cs-val" id="csEmail">0</div><div class="cs-label">Email</div></div>
    </div>
    <div id="contactListContainer">
      <div class="contact-empty">
        <div class="ce-icon">ğŸ‘¥</div>
        <div class="ce-title">No contacts yet</div>
        <div class="ce-sub">Import from your phone or add manually</div>
      </div>
    </div>
    <div class="contacts-footer">
      <button onclick="exportContacts()">ğŸ“¤ Export Backup</button>
      <button onclick="importContactsFile()">ğŸ“¥ Import Backup</button>
    </div>
  </div>
</div>

<!-- Contact Add/Edit Modal -->
<div class="contact-modal" id="contactModal">
  <div class="contact-modal-box">
    <h3 id="cmTitle">Add Contact</h3>
    <label>Full Name *</label>
    <input type="text" id="cmName" placeholder="John Doe">
    <label>Phone Number</label>
    <input type="tel" id="cmPhone" placeholder="+1 (555) 123-4567">
    <label>Email</label>
    <input type="email" id="cmEmail" placeholder="john@example.com">
    <label>$Cashtag / Venmo / Payment Handle</label>
    <input type="text" id="cmPayHandle" placeholder="$JohnDoe or @johndoe">
    <label>Notes</label>
    <input type="text" id="cmNotes" placeholder="Optional notes...">
    <div class="cm-btns">
      <button class="cm-btn cancel" onclick="closeContactModal()">Cancel</button>
      <button class="cm-btn danger" id="cmDeleteBtn" onclick="deleteContact()" style="display:none">Delete</button>
      <button class="cm-btn primary" onclick="saveContact()">Save</button>
    </div>
  </div>
</div>

<!-- Hidden file input for importing contacts -->
<input type="file" id="contactFileInput" accept=".json" style="display:none" onchange="handleContactFileImport(event)">

<!-- â•â•â•â•â•â•â• CHAT SCREEN â•â•â•â•â•â•â• -->
<div class="screen" id="screen-chat">
  <div class="header">
    <button class="back" onclick="showScreen('home')">â†</button>
    <img class="avatar" src="icon-192.png" alt="">
    <div class="info">
      <div class="name">Spine Rip</div>
      <div class="status" id="chatStatus">Spine Rip AI â€¢ online</div>
    </div>
    <button class="hbtn" onclick="toggleChatSearch()">ğŸ”</button>
    <button class="hbtn" onclick="showChatMenu(event)">â‹®</button>
  </div>
  <div class="search-bar" id="chatSearch">
    <input type="text" placeholder="Search messages..." id="chatSearchInput" oninput="searchMessages()">
    <button class="search-close" onclick="toggleChatSearch()">âœ•</button>
  </div>
  <div class="messages" id="messages" onscroll="onMessagesScroll()">
    <div class="msg-date">Today</div>
  </div>
  <div class="typing-indicator" id="typing">
    <div class="typing-dot"></div><div class="typing-dot"></div><div class="typing-dot"></div>
  </div>
  <button class="scroll-bottom" id="scrollBtn" onclick="scrollToBottom()">â†“</button>
  <div class="input-bar">
    <button class="attach" onclick="toggleAttach()">ğŸ“</button>
    <textarea id="msgInput" placeholder="Message" rows="1" oninput="autoGrow(this);updateSend()"></textarea>
    <button class="send disabled" id="sendBtn" onclick="sendMessage()">â¤</button>
  </div>
</div>

<!-- â•â•â•â•â•â•â• WALLET SCREEN â•â•â•â•â•â•â• -->
<div class="screen" id="screen-wallet">
  <div class="header">
    <button class="back" onclick="showScreen('home')">â†</button>
    <div class="info"><div class="name">Crypto Wallet</div><div class="status">Universal â€¢ Multi-Chain</div></div>
    <button class="hbtn" onclick="refreshWallet()">ğŸ”„</button>
  </div>
  <div class="wallet-body">
    <div class="wallet-card">
      <div class="wc-label">Total Balance</div>
      <div class="wc-balance" id="totalBalance">$0.00</div>
      <div class="wc-usd">Portfolio value (USD)</div>
    </div>
    <div class="wallet-actions">
      <button onclick="walletAction('send')"><span class="wa-icon">â†‘</span>Send</button>
      <button onclick="walletAction('receive')"><span class="wa-icon">â†“</span>Receive</button>
      <button onclick="walletAction('swap')"><span class="wa-icon">â‡„</span>Swap</button>
      <button onclick="walletAction('buy')"><span class="wa-icon">+</span>Buy</button>
    </div>
    <button class="wallet-connect-btn" style="margin-bottom:16px;background:var(--accent);color:#000;border-color:var(--accent);font-size:16px;padding:14px;border-radius:14px;" onclick="showScreen('pay')">
      ğŸ“² Tap to Pay â€” Stablecoins
    </button>
    <!-- Google Pay & Wallet Section -->
    <div class="gpay-section">
      <div class="gpay-title">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none"><path d="M12.24 10.285V14.4h6.806c-.275 1.765-2.056 5.174-6.806 5.174-4.095 0-7.439-3.389-7.439-7.574s3.345-7.574 7.439-7.574c2.33 0 3.891.989 4.785 1.849l3.254-3.138C18.189 1.186 15.479 0 12.24 0c-6.635 0-12 5.365-12 12s5.365 12 12 12c6.926 0 11.52-4.869 11.52-11.726 0-.788-.085-1.39-.189-1.989H12.24z" fill="#fff"/></svg>
        Google Pay & Wallet
      </div>
      <div class="gpay-desc">Link SubZero to Google Pay for quick payments, or add your wallet pass to Google Wallet.</div>
      <button class="gpay-btn" id="gpayLinkBtn" onclick="initGooglePay()">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none"><path d="M12.24 10.285V14.4h6.806c-.275 1.765-2.056 5.174-6.806 5.174-4.095 0-7.439-3.389-7.439-7.574s3.345-7.574 7.439-7.574c2.33 0 3.891.989 4.785 1.849l3.254-3.138C18.189 1.186 15.479 0 12.24 0c-6.635 0-12 5.365-12 12s5.365 12 12 12c6.926 0 11.52-4.869 11.52-11.726 0-.788-.085-1.39-.189-1.989H12.24z" fill="#4285F4"/></svg>
        Pay with Google Pay
      </button>
      <button class="gpay-btn-outline" id="gwalletAddBtn" onclick="addToGoogleWallet()">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none"><path d="M21.2 9.3l-2.8-2.3c-.4-.3-.9-.5-1.4-.5H7c-.5 0-1 .2-1.4.5L2.8 9.3c-.5.4-.8 1-.8 1.7v5c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2v-5c0-.7-.3-1.3-.8-1.7zM12 16c-1.7 0-3-1.3-3-3s1.3-3 3-3 3 1.3 3 3-1.3 3-3 3z" fill="currentColor"/></svg>
        Add to Google Wallet
      </button>
      <div class="gpay-status" id="gpayStatus"></div>
    </div>
    <!-- Netspend / Cash App / Venmo Section -->
    <div class="pay-service-section">
      <div class="pss-title">ğŸ’³ Payment Services</div>
      <div class="pss-desc">Link your Netspend, Cash App, or Venmo to send, receive, and withdraw funds.</div>
      <!-- Netspend -->
      <div id="netspendLinked" class="pay-svc-linked" style="display:none">âœ… Netspend linked â€” <span id="netspendTag"></span></div>
      <div id="netspendSetup">
        <input class="pay-svc-input" id="netspendCard" placeholder="Netspend Card Number (last 4 or full)">
        <button class="pay-svc-btn netspend" onclick="linkNetspend()">ğŸ¦ Link Netspend Card</button>
      </div>
      <div class="pay-svc-row" id="netspendActions" style="display:none">
        <button class="pay-svc-btn netspend" onclick="netspendAction('load')">â†“ Load</button>
        <button class="pay-svc-btn netspend" onclick="netspendAction('withdraw')">â†‘ Withdraw</button>
      </div>
      <!-- Cash App -->
      <div id="cashappLinked" class="pay-svc-linked" style="display:none">âœ… Cash App linked â€” <span id="cashappTag"></span></div>
      <div id="cashappSetup">
        <input class="pay-svc-input" id="cashappHandle" placeholder="$Cashtag (e.g. $YourName)">
        <button class="pay-svc-btn cashapp" onclick="linkCashApp()">ğŸ’² Link Cash App</button>
      </div>
      <div class="pay-svc-row" id="cashappActions" style="display:none">
        <button class="pay-svc-btn cashapp" onclick="cashAppAction('send')">â†‘ Send</button>
        <button class="pay-svc-btn cashapp" onclick="cashAppAction('request')">â†“ Request</button>
      </div>
      <!-- Venmo -->
      <div id="venmoLinked" class="pay-svc-linked" style="display:none">âœ… Venmo linked â€” <span id="venmoTag"></span></div>
      <div id="venmoSetup">
        <input class="pay-svc-input" id="venmoHandle" placeholder="Venmo username (e.g. @YourName)">
        <button class="pay-svc-btn venmo" onclick="linkVenmo()">â“‹ Link Venmo</button>
      </div>
      <div class="pay-svc-row" id="venmoActions" style="display:none">
        <button class="pay-svc-btn venmo" onclick="venmoAction('pay')">â†‘ Pay</button>
        <button class="pay-svc-btn venmo" onclick="venmoAction('request')">â†“ Request</button>
      </div>
    </div>
    <div class="wallet-section">
      <div class="ws-title">Assets</div>
      <div id="walletAssets">
        <div class="wallet-coin"><span class="wco-icon">â‚¿</span><div class="wco-info"><div class="wco-name">Bitcoin</div><div class="wco-amount">0.00 BTC</div></div><div class="wco-price"><div class="wco-val">$0.00</div><div class="wco-change up">â€”</div></div></div>
        <div class="wallet-coin"><span class="wco-icon">Î</span><div class="wco-info"><div class="wco-name">Ethereum</div><div class="wco-amount">0.00 ETH</div></div><div class="wco-price"><div class="wco-val">$0.00</div><div class="wco-change up">â€”</div></div></div>
        <div class="wallet-coin"><span class="wco-icon">â—</span><div class="wco-info"><div class="wco-name">Solana</div><div class="wco-amount">0.00 SOL</div></div><div class="wco-price"><div class="wco-val">$0.00</div><div class="wco-change up">â€”</div></div></div>
        <div class="wallet-coin"><span class="wco-icon">â—ˆ</span><div class="wco-info"><div class="wco-name">USDT</div><div class="wco-amount">0.00 USDT</div></div><div class="wco-price"><div class="wco-val">$0.00</div><div class="wco-change">stable</div></div></div>
      </div>
    </div>
    <div class="wallet-connect-section">
      <div class="wcs-title">ğŸ”— Connect Wallet</div>
      <div class="wcs-desc">Connect an external wallet or enter your API keys to enable trading and real-time balances.</div>
      <button class="wallet-connect-btn" onclick="connectWallet('walletconnect')">WalletConnect</button>
      <button class="wallet-connect-btn" style="margin-top:8px" onclick="connectWallet('metamask')">MetaMask</button>
      <button class="wallet-connect-btn" style="margin-top:8px" onclick="connectWallet('phantom')">Phantom (Solana)</button>
      <input class="api-key-input" id="cryptoApiKey" placeholder="Exchange API Key (Binance, Coinbase...)" style="margin-top:12px">
      <input class="api-key-input" id="cryptoApiSecret" placeholder="API Secret" style="margin-top:6px">
      <button class="wallet-connect-btn" style="margin-top:8px" onclick="saveCryptoKeys()">Save API Keys</button>
    </div>
  </div>
</div>

<!-- â•â•â•â•â•â•â• TAP TO PAY SCREEN â•â•â•â•â•â•â• -->
<div class="screen" id="screen-pay">
  <div class="header">
    <button class="back" onclick="showScreen('wallet')">â†</button>
    <div class="info"><div class="name">Tap to Pay</div><div class="status">Stablecoins â€¢ NFC + QR</div></div>
  </div>
  <div class="pay-body">
    <div class="pay-hero">
      <div class="pay-icon">ğŸ“±</div>
      <div class="pay-title">Pay with Stablecoins</div>
      <div class="pay-sub">Tap phones to pay instantly â€” or scan QR code</div>
    </div>
    <div class="pay-coin-select" id="payCoinSelect">
      <button class="pay-coin-btn active" onclick="selectPayCoin('USDT')">USDT</button>
      <button class="pay-coin-btn" onclick="selectPayCoin('USDC')">USDC</button>
      <button class="pay-coin-btn" onclick="selectPayCoin('DAI')">DAI</button>
      <button class="pay-coin-btn" onclick="selectPayCoin('BUSD')">BUSD</button>
    </div>
    <div class="pay-network-bar" id="payNetworks">
      <button class="pay-net-btn active" onclick="selectPayNet('ETH')">Ethereum</button>
      <button class="pay-net-btn" onclick="selectPayNet('BSC')">BSC</button>
      <button class="pay-net-btn" onclick="selectPayNet('POLYGON')">Polygon</button>
      <button class="pay-net-btn" onclick="selectPayNet('SOL')">Solana</button>
      <button class="pay-net-btn" onclick="selectPayNet('TRON')">Tron</button>
    </div>
    <div class="pay-amount-box">
      <input type="number" id="payAmount" placeholder="0.00" oninput="updatePayQR();updateFeeDisplay()">
      <div class="pay-usd"><span id="payCoinLabel">USDT</span> â€¢ â‰ˆ $<span id="payUsd">0.00</span></div>
    </div>
    <div class="fee-breakdown" id="feeBreakdown" style="display:none">
      <div class="fb-row"><span class="fb-label">Amount</span><span class="fb-val" id="fbAmount">$0.00</span></div>
      <div class="fb-row"><span class="fb-label fb-fee">Processing Fee (<span id="fbPct">2.9</span>% + $<span id="fbFlat">0.30</span>)</span><span class="fb-val fb-fee" id="fbFee">$0.00</span></div>
      <div class="fb-row total"><span class="fb-label">Total Charged</span><span class="fb-val" id="fbTotal">$0.00</span></div>
    </div>
    <div class="pay-tap-btn" id="tapPayBtn" onclick="tapToPay()">
      <div class="tap-ripple"></div>
      <div class="tap-icon">ğŸ“²</div>
      <div class="tap-label">TAP TO PAY</div>
    </div>
    <div class="pay-or">â€” or pay with â€”</div>
    <button class="gpay-btn" style="margin:0 0 12px;" onclick="googlePayCheckout()">
      <svg width="18" height="18" viewBox="0 0 24 24" fill="none"><path d="M12.24 10.285V14.4h6.806c-.275 1.765-2.056 5.174-6.806 5.174-4.095 0-7.439-3.389-7.439-7.574s3.345-7.574 7.439-7.574c2.33 0 3.891.989 4.785 1.849l3.254-3.138C18.189 1.186 15.479 0 12.24 0c-6.635 0-12 5.365-12 12s5.365 12 12 12c6.926 0 11.52-4.869 11.52-11.726 0-.788-.085-1.39-.189-1.989H12.24z" fill="#4285F4"/></svg>
      Pay with Google Pay
    </button>
    <div class="pay-checkout-row">
      <button class="pay-svc-btn cashapp" onclick="cashAppCheckout()">ğŸ’² Cash App</button>
      <button class="pay-svc-btn venmo" onclick="venmoCheckout()">â“‹ Venmo</button>
      <button class="pay-svc-btn netspend" onclick="netspendCheckout()">ğŸ¦ Netspend</button>
    </div>
    <div style="display:flex;gap:8px;margin:8px 0;">
      <button class="wallet-connect-btn" style="flex:1" onclick="showPayQR('receive')">ğŸ“¥ Receive (QR)</button>
      <button class="wallet-connect-btn" style="flex:1" onclick="showPayQR('send')">ğŸ“¤ Send</button>
    </div>
    <div class="pay-qr-methods" id="payQRMethods">
      <button class="pay-qr-btn active" onclick="selectQRMethod('crypto', event)">Crypto</button>
      <button class="pay-qr-btn" onclick="selectQRMethod('cashapp', event)">Cash App</button>
      <button class="pay-qr-btn" onclick="selectQRMethod('venmo', event)">Venmo</button>
    </div>
    <div class="pay-qr-section" id="payQRSection" style="display:none">
      <div class="pqs-label" id="payQRLabel">Scan to pay</div>
      <img id="payQRImg" src="" alt="Payment QR">
      <div class="pay-addr" id="payAddr" onclick="copyPayAddr()">Tap to copy address</div>
    </div>
    <div class="pay-history">
      <div class="ph-title">Recent Transactions</div>
      <div id="payTxList">
        <div style="text-align:center;color:var(--fg-dim);font-size:13px;padding:20px;">No transactions yet.<br>Tap to pay or receive stablecoins to get started.</div>
      </div>
    </div>
  </div>
</div>

<!-- â•â•â•â•â•â•â• SETTINGS SCREEN â•â•â•â•â•â•â• -->
<div class="screen" id="screen-settings">
  <div class="header">
    <button class="back" onclick="showScreen('home')">â†</button>
    <div class="info"><div class="name">Settings</div></div>
  </div>
  <div class="settings-body">
    <div class="settings-profile">
      <img src="icon-192.png" alt="">
      <div class="sp-name">SubZero</div>
      <div class="sp-sub">Flawless Victory â€¢ v2.5</div>
    </div>
    <div class="settings-group">AI Engine</div>
    <div class="settings-item" onclick="cycleModel()">
      <span class="si-icon">ğŸ§ </span>
      <div class="si-content"><div class="si-label">AI Model</div><div class="si-desc">Change the Ollama model</div></div>
      <span class="si-right" id="modelDisplay">qwen2.5:1.5b</span>
    </div>
    <div class="settings-item" onclick="checkStatus()">
      <span class="si-icon">ğŸŸ¢</span>
      <div class="si-content"><div class="si-label">Connection Status</div><div class="si-desc" id="connStatus">Checking...</div></div>
    </div>
    <div class="settings-item">
      <span class="si-icon">ğŸŒ</span>
      <div class="si-content"><div class="si-label">Server Address</div><div class="si-desc">Where Spine Rip is running</div></div>
      <span class="si-right" id="serverAddr">auto</span>
    </div>
    <div class="settings-group">Appearance</div>
    <div class="settings-item" onclick="toggleTheme()">
      <span class="si-icon">ğŸŒ™</span>
      <div class="si-content"><div class="si-label">Dark Theme</div><div class="si-desc">Switch between dark and light</div></div>
      <label class="toggle"><input type="checkbox" id="themeToggle" checked onchange="toggleTheme()"><span class="slider"></span></label>
    </div>
    <div class="settings-group">Fee Income</div>
    <div class="settings-item" onclick="showScreen('income')">
      <span class="si-icon">ğŸ’°</span>
      <div class="si-content"><div class="si-label">Income Dashboard</div><div class="si-desc" id="incomePreview">View your fee earnings</div></div>
      <span class="si-right" id="incomeTotal">$0.00</span>
    </div>
    <div class="settings-group">Data</div>
    <div class="settings-item" onclick="clearHistory()">
      <span class="si-icon">ğŸ—‘ï¸</span>
      <div class="si-content"><div class="si-label">Clear Chat History</div><div class="si-desc">Delete all messages</div></div>
    </div>
    <div class="settings-group">About</div>
    <div class="settings-item" onclick="showScreen('share')">
      <span class="si-icon">ğŸ“¥</span>
      <div class="si-content"><div class="si-label">Download Desktop App</div><div class="si-desc">Get SubZero for your PC</div></div>
    </div>
    <div class="settings-item" onclick="showScreen('instructions')">
      <span class="si-icon">ğŸ“–</span>
      <div class="si-content"><div class="si-label">How to Use</div><div class="si-desc">Setup and usage guide</div></div>
    </div>
  </div>
</div>

<!-- â•â•â•â•â•â•â• SHARE / QR SCREEN â•â•â•â•â•â•â• -->
<div class="screen" id="screen-share">
  <div class="header">
    <button class="back" onclick="showScreen('home')">â†</button>
    <div class="info"><div class="name">Download & Share</div></div>
  </div>
  <div class="share-body">
    <img class="logo-big" src="icon-192.png" alt="">
    <h2>S U B - Z E R O</h2>
    <div class="sub">F L A W L E S S  V I C T O R Y</div>
    <div class="share-label">Scan to Download â€” Spine Rip AI</div>
    <div class="qr-box">
      <img id="qrImage" src="" alt="QR Code">
    </div>
    <div class="share-desc">Share this QR code with anyone â€” they'll get the full Spine Rip AI powered SubZero app from GitHub.</div>
    <button class="share-btn" onclick="shareApp()">Share SubZero</button>
    <button class="share-btn outline" onclick="copyLink()">Copy Download Link</button>
  </div>
</div>

<!-- â•â•â•â•â•â•â• INSTRUCTIONS SCREEN â•â•â•â•â•â•â• -->
<div class="screen" id="screen-instructions">
  <div class="header">
    <button class="back" onclick="showScreen('home')">â†</button>
    <div class="info"><div class="name">How to Use SubZero</div></div>
  </div>
  <div class="instructions-body">
    <h3 style="color:var(--accent);margin-bottom:16px;">ğŸ“± Using the Mobile App</h3>
    <div class="inst-step"><div class="inst-num">1</div><div class="inst-text">Open the app and tap <b>Spine Rip Chat</b> to start messaging the AI.</div></div>
    <div class="inst-step"><div class="inst-num">2</div><div class="inst-text">Type any question or command. Spine Rip uses <b>qwen2.5:1.5b</b> running locally on your PC â€” no cloud needed.</div></div>
    <div class="inst-step"><div class="inst-num">3</div><div class="inst-text">Spine Rip can <b>run commands</b>, <b>read/write files</b>, <b>search the web</b>, and <b>automate your browser</b> â€” all from your phone.</div></div>
    <div class="inst-step"><div class="inst-num">4</div><div class="inst-text">Long-press any message to <b>copy</b>, <b>reply</b>, or <b>delete</b> it.</div></div>

    <h3 style="color:var(--accent);margin:24px 0 16px;">ğŸ’» Desktop Setup</h3>
    <div class="inst-step"><div class="inst-num">1</div><div class="inst-text">On your PC, go to your <b>Desktop</b> and double-click the <b>"Sub-Zero Flawless Victory"</b> shortcut, or the <b>"Spine Rip"</b> icon.</div></div>
    <div class="inst-step"><div class="inst-num">2</div><div class="inst-text">If you don't have the desktop app yet, scan the QR code in the <b>Download & Share</b> section to get it from GitHub.</div></div>
    <div class="inst-step"><div class="inst-num">3</div><div class="inst-text">Make sure <b>Ollama</b> is running on your PC: open a terminal and type <b>ollama serve</b></div></div>
    <div class="inst-step"><div class="inst-num">4</div><div class="inst-text">Pull the AI model: <b>ollama pull qwen2.5:1.5b</b></div></div>
    <div class="inst-step"><div class="inst-num">5</div><div class="inst-text">Start the mobile server: <b>python sz_server.py</b> â€” then your phone connects automatically over WiFi.</div></div>

    <h3 style="color:var(--accent);margin:24px 0 16px;">ğŸ”— Connecting Your Phone</h3>
    <div class="inst-step"><div class="inst-num">1</div><div class="inst-text">Your phone and PC must be on the <b>same WiFi network</b>.</div></div>
    <div class="inst-step"><div class="inst-num">2</div><div class="inst-text">Scan the QR code that appears when you run <b>sz_server.py</b>, or type the URL manually.</div></div>
    <div class="inst-step"><div class="inst-num">3</div><div class="inst-text">Tap <b>"Add to Home Screen"</b> in your browser menu to install SubZero as an app on your phone.</div></div>
  </div>
</div>

<!-- â•â•â•â•â•â•â• INCOME DASHBOARD SCREEN â•â•â•â•â•â•â• -->
<div class="screen" id="screen-income">
  <div class="header">
    <button class="back" onclick="showScreen('settings')">â†</button>
    <div class="info"><div class="name">Income Dashboard</div><div class="status">Your fee earnings</div></div>
    <button class="hbtn" onclick="loadIncome()">ğŸ”„</button>
  </div>
  <div class="wallet-body" style="padding:16px">
    <div class="income-card">
      <div class="ic-label">Total Fee Income</div>
      <div class="ic-amount" id="dashIncome">$0.00</div>
      <div class="ic-sub" id="dashSub">0 transactions</div>
      <div class="ic-row">
        <div class="ic-stat"><div class="ic-stat-val" id="dashVolume">$0</div><div class="ic-stat-label">Total Volume</div></div>
        <div class="ic-stat"><div class="ic-stat-val" id="dashTxCount">0</div><div class="ic-stat-label">Transactions</div></div>
        <div class="ic-stat"><div class="ic-stat-val" id="dashAvgFee">$0</div><div class="ic-stat-label">Avg Fee</div></div>
      </div>
    </div>
    <div style="font-size:14px;font-weight:600;color:var(--accent);margin-bottom:8px;">Recent Fee Income</div>
    <div id="dashTxList">
      <div style="text-align:center;color:var(--fg-dim);font-size:13px;padding:20px;">No fee income yet.<br>Fees are recorded when users pay via your app.</div>
    </div>
    <div style="margin-top:16px;padding:12px;background:var(--bg3);border-radius:10px;font-size:12px;color:var(--fg-dim);">
      â„¹ï¸ <b>How it works:</b> Every time someone pays through your SubZero app, a <span style="color:var(--orange)">2.9% + $0.30</span> fee is collected. For Stripe/Google Pay, it goes directly to your Stripe account. For Cash App/Venmo/crypto, the fee is added to the total amount and the user pays you separately.
    </div>
  </div>
</div>

<!-- â•â•â•â•â•â•â• CONTEXT MENU â•â•â•â•â•â•â• -->
<div class="ctx-menu" id="ctxMenu">
  <div class="ctx-item" onclick="ctxAction('reply')"><span class="ctx-icon">â†©ï¸</span>Reply</div>
  <div class="ctx-item" onclick="ctxAction('copy')"><span class="ctx-icon">ğŸ“‹</span>Copy</div>
  <div class="ctx-item" onclick="ctxAction('forward')"><span class="ctx-icon">â†—ï¸</span>Forward</div>
  <div class="ctx-item" onclick="ctxAction('delete')"><span class="ctx-icon">ğŸ—‘ï¸</span>Delete</div>
</div>

<!-- â•â•â•â•â•â•â• ATTACH MENU â•â•â•â•â•â•â• -->
<div class="attach-menu" id="attachMenu">
  <div class="attach-grid">
    <div class="attach-option" onclick="attachAction('photo')"><div class="ao-icon" style="background:#4e8ef7">ğŸ“·</div><div class="ao-label">Photo</div></div>
    <div class="attach-option" onclick="attachAction('file')"><div class="ao-icon" style="background:#e65750">ğŸ“„</div><div class="ao-label">File</div></div>
    <div class="attach-option" onclick="attachAction('command')"><div class="ao-icon" style="background:#9b59b6">âŒ¨ï¸</div><div class="ao-label">Command</div></div>
    <div class="attach-option" onclick="attachAction('tools')"><div class="ao-icon" style="background:#03dac6">ğŸ”§</div><div class="ao-label">Tools</div></div>
  </div>
</div>

<!-- â•â•â•â•â•â•â• QR SCANNER OVERLAY â•â•â•â•â•â•â• -->
<div id="scanOverlay">
  <button id="scanClose" onclick="stopQRScanner()">âœ• Close</button>
  <video id="scanVideo" autoplay muted playsinline></video>
  <div id="scanHint">Align the QR inside the frame</div>
</div>

<!-- â•â•â•â•â•â•â• CHAT MENU (3-dot) â•â•â•â•â•â•â• -->
<div class="ctx-menu" id="chatMenu">
  <div class="ctx-item" onclick="toggleChatSearch();closeChatMenu()"><span class="ctx-icon">ğŸ”</span>Search</div>
  <div class="ctx-item" onclick="clearHistory();closeChatMenu()"><span class="ctx-icon">ğŸ—‘ï¸</span>Clear history</div>
  <div class="ctx-item" onclick="showScreen('wallet');closeChatMenu()"><span class="ctx-icon">ğŸ’°</span>Wallet</div>
  <div class="ctx-item" onclick="showScreen('share');closeChatMenu()"><span class="ctx-icon">ğŸ“¤</span>Share app</div>
  <div class="ctx-item" onclick="showScreen('settings');closeChatMenu()"><span class="ctx-icon">âš™ï¸</span>Settings</div>
</div>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  SUBZERO PAY P2P
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let szpMode = 'request';
let szpRoute = 'cashapp';
let szpTxHistory = JSON.parse(localStorage.getItem('szp_tx') || '[]');

function setSZPayMode(mode) {
  szpMode = mode;
  document.getElementById('szpModeRequest').classList.toggle('active', mode === 'request');
  document.getElementById('szpModeScan').classList.toggle('active', mode === 'scan');
  document.getElementById('szpRequestPanel').style.display = mode === 'request' ? '' : 'none';
  document.getElementById('szpScanPanel').style.display = mode === 'scan' ? '' : 'none';
}

function setSZPRoute(route, el) {
  szpRoute = route;
  document.querySelectorAll('.szpay-route-btn').forEach(b => b.classList.remove('active'));
  if (el) el.classList.add('active');
}

function calcSZPFee(amount) {
  const pct = 2.9, flat = 0.30;
  const fee = Math.round((amount * pct / 100 + flat) * 100) / 100;
  return { amount, fee, total: Math.round((amount + fee) * 100) / 100 };
}

function updateSZPFee() {
  const amt = parseFloat(document.getElementById('szpAmount').value || '0');
  const box = document.getElementById('szpFeeBox');
  if (amt <= 0) { box.style.display = 'none'; return; }
  const f = calcSZPFee(amt);
  box.style.display = '';
  document.getElementById('szpFeeAmt').textContent = '$' + f.amount.toFixed(2);
  document.getElementById('szpFeeFee').textContent = '$' + f.fee.toFixed(2);
  document.getElementById('szpFeeTotal').textContent = '$' + f.total.toFixed(2);
}

function generateSZPayQR() {
  const amt = parseFloat(document.getElementById('szpAmount').value || '0');
  if (amt <= 0) { alert('Enter an amount'); return; }
  const f = calcSZPFee(amt);
  const note = document.getElementById('szpNote').value.trim() || 'SubZero Payment';

  // Build SubZero pay URI
  const params = new URLSearchParams({
    amount: f.total.toFixed(2),
    base: f.amount.toFixed(2),
    fee: f.fee.toFixed(2),
    route: szpRoute,
    note: note,
    ts: Date.now().toString()
  });

  // Add payment handles from linked accounts
  const cashTag = localStorage.getItem('sz_cashapp') || '';
  const venmoUser = localStorage.getItem('sz_venmo') || '';
  const cryptoAddr = localStorage.getItem('sz_wallet_addr_SOL') || localStorage.getItem('sz_wallet_addr_ETH') || '';
  if (cashTag) params.set('cashapp', cashTag);
  if (venmoUser) params.set('venmo', venmoUser);
  if (cryptoAddr) params.set('addr', cryptoAddr);

  const uri = 'subzero:pay?' + params.toString();
  const qrUrl = 'https://api.qrserver.com/v1/create-qr-code/?size=220x220&data=' + encodeURIComponent(uri) + '&bgcolor=0a0a12&color=03dac6';

  document.getElementById('szpQRImg').src = qrUrl;
  document.getElementById('szpQRAmount').textContent = '$' + f.total.toFixed(2);
  document.getElementById('szpQRFee').textContent = 'Includes $' + f.fee.toFixed(2) + ' SubZero fee';
  const routeNames = { cashapp: 'ğŸ’² Cash App', venmo: 'â“‹ Venmo', crypto: 'ğŸª™ Crypto', googlepay: 'ğŸ”· Google Pay', mercadopago: 'ğŸŸ¢ Mercado Pago', phonepe: 'ğŸ“± PhonePe', wechat: 'ğŸ’¬ WeChat Pay', card: 'ğŸ’³ Card' };
  document.getElementById('szpQRRoute').textContent = 'Pay via: ' + (routeNames[szpRoute] || szpRoute);
  document.getElementById('szpQRNote').textContent = note;
  document.getElementById('szpQRResult').style.display = '';

  // Log as "requested"
  addSZPTx('requested', f.amount, f.fee, szpRoute, note);
}

function shareSZPayQR() {
  const img = document.getElementById('szpQRImg');
  const amt = document.getElementById('szpQRAmount').textContent;
  if (navigator.share) {
    navigator.share({
      title: 'SubZero Pay â€” ' + amt,
      text: 'Pay me ' + amt + ' via SubZero Pay! Scan the QR code in the SubZero app.',
      url: img.src
    }).catch(() => {});
  } else {
    navigator.clipboard?.writeText(img.src);
    alert('QR link copied!');
  }
}

function startSZPayScan() {
  startQRScanner();
}

// â”€â”€ Linked Payment Methods â”€â”€
let linkedMethods = JSON.parse(localStorage.getItem('szp_methods') || '[]');

function saveLinkedMethods() {
  localStorage.setItem('szp_methods', JSON.stringify(linkedMethods));
  renderLinkedMethods();
}

function renderLinkedMethods() {
  const el = document.getElementById('spwLinkedList');
  if (!linkedMethods.length) {
    el.innerHTML = '<div style="text-align:center;color:var(--fg-dim);font-size:12px;padding:8px;">No payment methods linked yet.</div>';
    updateDefaultMethodLabel();
    return;
  }
  el.innerHTML = linkedMethods.map((m, i) => {
    const icons = { card:'ğŸ’³', cashapp:'ğŸ’²', venmo:'â“‹', googlepay:'ğŸ”·', mercadopago:'ğŸŸ¢', phonepe:'ğŸ“±', wechat:'ğŸ’¬' };
    const names = { card:'Card', cashapp:'Cash App', venmo:'Venmo', googlepay:'Google Pay', mercadopago:'Mercado Pago', phonepe:'PhonePe', wechat:'WeChat Pay' };
    const isDefault = i === 0;
    return `<div class="spw-card${isDefault ? ' default' : ''}" onclick="setDefaultMethod(${i})">
      <div class="spwc-icon">${icons[m.type] || 'ğŸ’³'}</div>
      <div class="spwc-info">
        <div class="spwc-name">${names[m.type] || m.type}${isDefault ? ' <span class="spwc-default">DEFAULT</span>' : ''}</div>
        <div class="spwc-detail">${m.detail}</div>
      </div>
      <button class="spwc-remove" onclick="event.stopPropagation();removeMethod(${i})">âœ•</button>
    </div>`;
  }).join('');
  updateDefaultMethodLabel();
}

function updateDefaultMethodLabel() {
  const el = document.getElementById('szpDefaultMethod');
  if (!el) return;
  if (linkedMethods.length) {
    const names = { card:'Card', cashapp:'Cash App', venmo:'Venmo', googlepay:'Google Pay', mercadopago:'Mercado Pago', phonepe:'PhonePe', wechat:'WeChat Pay' };
    el.textContent = names[linkedMethods[0].type] || linkedMethods[0].type;
  } else {
    el.textContent = 'no method linked';
  }
}

function setDefaultMethod(idx) {
  const m = linkedMethods.splice(idx, 1)[0];
  linkedMethods.unshift(m);
  saveLinkedMethods();
}

function removeMethod(idx) {
  if (confirm('Remove this payment method?')) {
    linkedMethods.splice(idx, 1);
    saveLinkedMethods();
  }
}

function toggleAddCard() {
  const form = document.getElementById('spwAddCardForm');
  form.style.display = form.style.display === 'none' ? '' : 'none';
}

function formatCardNum(el) {
  let v = el.value.replace(/\D/g, '').substring(0, 16);
  el.value = v.replace(/(\d{4})(?=\d)/g, '$1 ');
}
function formatCardExp(el) {
  let v = el.value.replace(/\D/g, '').substring(0, 4);
  if (v.length >= 3) v = v.substring(0,2) + '/' + v.substring(2);
  el.value = v;
}

function saveLinkedCard() {
  const num = document.getElementById('spwCardNum').value.replace(/\s/g, '');
  const exp = document.getElementById('spwCardExp').value;
  const name = document.getElementById('spwCardName').value.trim();
  if (num.length < 13) { alert('Enter a valid card number'); return; }
  if (!exp || exp.length < 4) { alert('Enter expiry date'); return; }
  const last4 = num.slice(-4);
  // Detect card brand
  let brand = 'Card';
  if (num[0] === '4') brand = 'Visa';
  else if (['51','52','53','54','55'].includes(num.substring(0,2)) || (parseInt(num.substring(0,4)) >= 2221 && parseInt(num.substring(0,4)) <= 2720)) brand = 'Mastercard';
  else if (['34','37'].includes(num.substring(0,2))) brand = 'Amex';
  else if (num.substring(0,4) === '6011' || num.substring(0,2) === '65') brand = 'Discover';

  linkedMethods.push({
    type: 'card',
    detail: brand + ' â€¢â€¢â€¢â€¢ ' + last4 + ' | ' + exp,
    last4, brand, exp,
    name: name || 'Card Holder',
    // Store encrypted-ish (base64) â€” not true encryption, just local obfuscation
    _enc: btoa(num)
  });
  saveLinkedMethods();
  // Clear form
  document.getElementById('spwCardNum').value = '';
  document.getElementById('spwCardExp').value = '';
  document.getElementById('spwCardCVV').value = '';
  document.getElementById('spwCardName').value = '';
  document.getElementById('spwAddCardForm').style.display = 'none';
  alert('âœ… ' + brand + ' â€¢â€¢â€¢â€¢ ' + last4 + ' saved!');
}

function linkQuickMethod(type) {
  const names = { cashapp:'Cash App', venmo:'Venmo', googlepay:'Google Pay', mercadopago:'Mercado Pago', phonepe:'PhonePe', wechat:'WeChat Pay' };
  const prompts = {
    cashapp: 'Enter your $Cashtag (e.g. $YourName):',
    venmo: 'Enter your Venmo username (e.g. @YourName):',
    googlepay: 'Enter the email linked to your Google Pay:',
    mercadopago: 'Enter your Mercado Pago email or phone:',
    phonepe: 'Enter your PhonePe UPI ID or phone number:',
    wechat: 'Enter your WeChat Pay ID:'
  };
  // Check if already linked
  if (linkedMethods.some(m => m.type === type)) {
    alert(names[type] + ' is already linked!'); return;
  }
  const handle = prompt(prompts[type]);
  if (!handle || !handle.trim()) return;
  linkedMethods.push({ type, detail: handle.trim() });
  saveLinkedMethods();
  // Also store in legacy keys for QR generation
  if (type === 'cashapp') localStorage.setItem('sz_cashapp', handle.trim());
  if (type === 'venmo') localStorage.setItem('sz_venmo', handle.trim());
  alert('âœ… ' + names[type] + ' linked: ' + handle.trim());
}

renderLinkedMethods();

function addSZPTx(type, amount, fee, route, note) {
  const tx = {
    type, amount, fee, route, note,
    time: new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }),
    date: new Date().toLocaleDateString()
  };
  szpTxHistory.unshift(tx);
  if (szpTxHistory.length > 50) szpTxHistory = szpTxHistory.slice(0, 50);
  localStorage.setItem('szp_tx', JSON.stringify(szpTxHistory));
  renderSZPTx();
}

function renderSZPTx() {
  const el = document.getElementById('szpTxList');
  if (!szpTxHistory.length) {
    el.innerHTML = '<div style="text-align:center;color:var(--fg-dim);font-size:13px;padding:20px;">No SubZero Pay transactions yet.</div>';
    return;
  }
  const routeNames = { cashapp: 'ğŸ’² Cash App', venmo: 'â“‹ Venmo', crypto: 'ğŸª™ Crypto', googlepay: 'ğŸ”· Google Pay', mercadopago: 'ğŸŸ¢ Mercado Pago', phonepe: 'ğŸ“± PhonePe', wechat: 'ğŸ’¬ WeChat Pay', card: 'ğŸ’³ Card' };
  el.innerHTML = szpTxHistory.slice(0, 15).map(tx => {
    const icon = tx.type === 'requested' ? 'ğŸ“²' : tx.type === 'paid' ? 'âœ…' : 'â†—ï¸';
    const cls = tx.type === 'paid' ? 'sent' : 'received';
    const sign = tx.type === 'paid' ? '-' : '+';
    return `<div class="szpay-tx">
      <div class="spt-icon">${icon}</div>
      <div class="spt-info">
        <div class="spt-method">${tx.type === 'requested' ? 'Requested' : 'Paid'} via ${routeNames[tx.route] || tx.route}</div>
        <div class="spt-time">${tx.date} ${tx.time} â€” ${tx.note || ''}</div>
      </div>
      <div class="spt-amount ${cls}">${sign}$${parseFloat(tx.amount).toFixed(2)}</div>
    </div>`;
  }).join('');
}
renderSZPTx();

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  SUBZERO MAIL
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let szmailData = JSON.parse(localStorage.getItem('sz_mail') || 'null');
let szmailTxHistory = JSON.parse(localStorage.getItem('sz_mail_tx') || '[]');

function initSZMail() {
  if (szmailData && szmailData.email) {
    showMailLinked();
  } else {
    document.getElementById('szmailSetupSection').style.display = '';
    document.getElementById('szmailLinkedSection').style.display = 'none';
    document.getElementById('szmailQRSection').style.display = 'none';
    document.getElementById('szmailActions').style.display = 'none';
    document.getElementById('szmailSendSection').style.display = 'none';
    document.getElementById('szmailHistory').style.display = 'none';
  }
}

function showMailLinked() {
  document.getElementById('szmailSetupSection').style.display = 'none';
  document.getElementById('szmailLinkedSection').style.display = '';
  document.getElementById('szmailAddr').textContent = szmailData.email;
  // Generate email QR
  const uri = 'subzero:email?' + new URLSearchParams({
    email: szmailData.email,
    name: szmailData.name || '',
    wallet: szmailData.wallet || ''
  }).toString();
  const qrUrl = 'https://api.qrserver.com/v1/create-qr-code/?size=200x200&data=' + encodeURIComponent(uri) + '&bgcolor=0a0a12&color=03dac6';
  document.getElementById('szmailQRImg').src = qrUrl;
  document.getElementById('szmailQRAddr').textContent = szmailData.email;
  document.getElementById('szmailQRSection').style.display = '';
  document.getElementById('szmailActions').style.display = '';
  document.getElementById('szmailSendSection').style.display = '';
  // Show history if any
  renderSZMailTx();
}

function saveSZMail() {
  const email = document.getElementById('szmailInput').value.trim();
  const name = document.getElementById('szmailName').value.trim();
  const wallet = document.getElementById('szmailWallet').value.trim();
  if (!email || !email.includes('@')) { alert('Enter a valid email address'); return; }
  szmailData = { email, name, wallet, linkedAt: Date.now() };
  localStorage.setItem('sz_mail', JSON.stringify(szmailData));
  showMailLinked();
  alert('âœ… ' + email + ' linked to SubZero!');
}

function editSZMail() {
  document.getElementById('szmailSetupSection').style.display = '';
  document.getElementById('szmailLinkedSection').style.display = 'none';
  if (szmailData) {
    document.getElementById('szmailInput').value = szmailData.email || '';
    document.getElementById('szmailName').value = szmailData.name || '';
    document.getElementById('szmailWallet').value = szmailData.wallet || '';
  }
}

function shareSZMailQR() {
  if (!szmailData) return;
  const img = document.getElementById('szmailQRImg');
  if (navigator.share) {
    navigator.share({
      title: 'SubZero Mail â€” ' + szmailData.email,
      text: 'Scan this QR to get my email and send me stablecoins via SubZero! ' + szmailData.email,
      url: img.src
    }).catch(() => {});
  } else {
    navigator.clipboard?.writeText(szmailData.email);
    alert('Email copied: ' + szmailData.email);
  }
}

function scanEmailQR() {
  // Use the existing QR scanner â€” the onQRDetected handler will catch subzero:email URIs
  startQRScanner();
}

function copyEmailAddr() {
  if (!szmailData) return;
  navigator.clipboard?.writeText(szmailData.email);
  alert('ğŸ“‹ Copied: ' + szmailData.email);
}

function updateSZMailFee() {
  const amt = parseFloat(document.getElementById('szmSendAmount').value || '0');
  const box = document.getElementById('szmFeeBox');
  if (amt <= 0) { box.style.display = 'none'; return; }
  const f = calcSZPFee(amt);
  box.style.display = '';
  document.getElementById('szmFeeAmt').textContent = '$' + f.amount.toFixed(2);
  document.getElementById('szmFeeFee').textContent = '$' + f.fee.toFixed(2);
  document.getElementById('szmFeeTotal').textContent = '$' + f.total.toFixed(2);
}

// Send stablecoins to an email via QR
function sendCoinToEmail() {
  const to = document.getElementById('szmSendTo').value.trim();
  const amount = parseFloat(document.getElementById('szmSendAmount').value || '0');
  const coin = document.getElementById('szmSendCoin').value;
  const note = document.getElementById('szmSendNote').value.trim();

  if (!to || !to.includes('@')) { alert('Enter recipient email'); return; }
  if (amount <= 0) { alert('Enter an amount'); return; }

  const f = calcSZPFee(amount);

  // Build transfer URI
  const params = new URLSearchParams({
    from: szmailData ? szmailData.email : 'unknown',
    to: to,
    amount: f.total.toFixed(2),
    base: f.amount.toFixed(2),
    fee: f.fee.toFixed(2),
    coin: coin,
    note: note || 'SubZero Mail Transfer',
    wallet: szmailData ? szmailData.wallet : '',
    ts: Date.now().toString()
  });
  const uri = 'subzero:mailtx?' + params.toString();
  const qrUrl = 'https://api.qrserver.com/v1/create-qr-code/?size=180x180&data=' + encodeURIComponent(uri) + '&bgcolor=0a0a12&color=03dac6';

  document.getElementById('szmSendQRImg').src = qrUrl;
  document.getElementById('szmSendResult').style.display = '';

  // Record fee income to dashboard
  recordFeeToServer('SubZero Mail', Math.round(f.amount * 100), coin + ' transfer to ' + to);

  // Log transaction
  szmailTxHistory.unshift({
    type: 'sent', to, from: szmailData ? szmailData.email : 'you',
    amount: f.amount, fee: f.fee, total: f.total, coin, note: note || 'Transfer',
    time: new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }),
    date: new Date().toLocaleDateString()
  });
  if (szmailTxHistory.length > 50) szmailTxHistory = szmailTxHistory.slice(0, 50);
  localStorage.setItem('sz_mail_tx', JSON.stringify(szmailTxHistory));
  renderSZMailTx();
}

function renderSZMailTx() {
  const el = document.getElementById('szmailTxList');
  const histDiv = document.getElementById('szmailHistory');
  if (!szmailTxHistory.length) {
    histDiv.style.display = 'none';
    return;
  }
  histDiv.style.display = '';
  el.innerHTML = szmailTxHistory.slice(0, 20).map(tx => {
    const icon = tx.type === 'sent' ? 'â†—ï¸' : 'â†™ï¸';
    const cls = tx.type === 'sent' ? 'sent' : 'received';
    const sign = tx.type === 'sent' ? '-' : '+';
    const who = tx.type === 'sent' ? tx.to : tx.from;
    return `<div class="szmail-tx">
      <div class="smt-icon">${icon}</div>
      <div class="smt-info">
        <div class="smt-to">${tx.type === 'sent' ? 'Sent to' : 'From'} ${escHtml(who)}</div>
        <div class="smt-time">${tx.date} ${tx.time} â€¢ ${tx.coin} â€¢ ${tx.note || ''}</div>
      </div>
      <div class="smt-amount ${cls}">${sign}$${parseFloat(tx.total).toFixed(2)}</div>
    </div>`;
  }).join('');
}

// Handle scanned email QR codes (called from onQRDetected)
function handleEmailQR(data) {
  try {
    const url = new URL(data.replace('subzero:email?', 'https://x.com/?'));
    const email = url.searchParams.get('email');
    const name = url.searchParams.get('name') || '';
    const wallet = url.searchParams.get('wallet') || '';
    if (!email) return false;

    // Add to contacts if not exists
    if (typeof szContacts !== 'undefined') {
      const exists = szContacts.some(c => c.email === email);
      if (!exists) {
        szContacts.push({
          name: name || email.split('@')[0],
          phone: '',
          email: email,
          payHandle: wallet ? 'wallet:' + wallet : '',
          notes: 'Added via SubZero Mail QR scan',
          source: 'qr',
          addedAt: Date.now()
        });
        saveContacts();
      }
    }

    // Offer to send crypto
    if (confirm('ğŸ“§ Found: ' + email + (name ? ' (' + name + ')' : '') + '\n\nAdded to Contacts!\n\nSend stablecoins to this email?')) {
      showScreen('szmail');
      document.getElementById('szmSendTo').value = email;
    }
    return true;
  } catch (e) {
    return false;
  }
}

function handleMailTxQR(data) {
  try {
    const url = new URL(data.replace('subzero:mailtx?', 'https://x.com/?'));
    const from = url.searchParams.get('from');
    const to = url.searchParams.get('to');
    const amount = url.searchParams.get('amount');
    const coin = url.searchParams.get('coin');
    const note = url.searchParams.get('note');
    const wallet = url.searchParams.get('wallet');
    if (!from || !amount) return false;

    alert('ğŸª™ Stablecoin Transfer\n\nFrom: ' + from + '\nAmount: $' + amount + ' ' + coin + '\nNote: ' + note +
      (wallet ? '\n\nSend ' + coin + ' to wallet:\n' + wallet : '\n\nNo wallet address provided.'));

    // Log as received
    szmailTxHistory.unshift({
      type: 'received', to, from, amount: parseFloat(url.searchParams.get('base') || amount),
      fee: parseFloat(url.searchParams.get('fee') || 0),
      total: parseFloat(amount), coin, note: note || 'Transfer',
      time: new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }),
      date: new Date().toLocaleDateString()
    });
    localStorage.setItem('sz_mail_tx', JSON.stringify(szmailTxHistory));
    renderSZMailTx();
    return true;
  } catch (e) {
    return false;
  }
}

initSZMail();

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  CONTACTS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let szContacts = JSON.parse(localStorage.getItem('sz_contacts') || '[]');
let editingContactIdx = -1;

const avatarColors = ['#e91e63','#9c27b0','#673ab7','#3f51b5','#2196f3','#009688','#4caf50','#ff9800','#ff5722','#795548'];
function getAvatarColor(name) {
  let hash = 0;
  for (let i = 0; i < name.length; i++) hash = name.charCodeAt(i) + ((hash << 5) - hash);
  return avatarColors[Math.abs(hash) % avatarColors.length];
}
function getInitials(name) {
  const parts = name.trim().split(/\s+/);
  if (parts.length >= 2) return (parts[0][0] + parts[parts.length-1][0]).toUpperCase();
  return name.substring(0, 2).toUpperCase();
}

function saveContacts() {
  localStorage.setItem('sz_contacts', JSON.stringify(szContacts));
  renderContacts();
  updateContactStats();
}

function updateContactStats() {
  const total = szContacts.length;
  const withPhone = szContacts.filter(c => c.phone).length;
  const withEmail = szContacts.filter(c => c.email).length;
  document.getElementById('csTotal').textContent = total;
  document.getElementById('csPhone').textContent = withPhone;
  document.getElementById('csEmail').textContent = withEmail;
  document.getElementById('contactStatusBar').textContent = total + ' contact' + (total !== 1 ? 's' : '');
  const countEl = document.getElementById('contactCount');
  if (countEl) countEl.textContent = total;
}

function renderContacts(filter) {
  const container = document.getElementById('contactListContainer');
  let list = [...szContacts];

  if (filter) {
    const q = filter.toLowerCase();
    list = list.filter(c =>
      (c.name || '').toLowerCase().includes(q) ||
      (c.phone || '').includes(q) ||
      (c.email || '').toLowerCase().includes(q) ||
      (c.payHandle || '').toLowerCase().includes(q)
    );
  }

  if (!list.length) {
    container.innerHTML = `<div class="contact-empty">
      <div class="ce-icon">${filter ? 'ğŸ”' : 'ğŸ‘¥'}</div>
      <div class="ce-title">${filter ? 'No matches' : 'No contacts yet'}</div>
      <div class="ce-sub">${filter ? 'Try a different search' : 'Import from your phone or add manually'}</div>
    </div>`;
    return;
  }

  // Sort alphabetically
  list.sort((a, b) => (a.name || '').localeCompare(b.name || ''));

  // Group by first letter
  let html = '';
  let currentLetter = '';
  list.forEach(c => {
    const idx = szContacts.indexOf(c);
    const letter = (c.name || '?')[0].toUpperCase();
    if (letter !== currentLetter) {
      currentLetter = letter;
      html += `<div class="contact-section-header">${letter}</div>`;
    }
    const color = getAvatarColor(c.name || 'X');
    const initials = getInitials(c.name || '??');
    const detail = c.phone || c.email || c.payHandle || 'No details';
    html += `<div class="contact-item" onclick="openEditContact(${idx})">
      <div class="contact-avatar" style="background:${color}">${initials}</div>
      <div class="contact-info">
        <div class="contact-name">${escHtml(c.name)}</div>
        <div class="contact-detail">${escHtml(detail)}</div>
      </div>
      <div class="contact-actions">
        ${c.phone ? `<button class="contact-action-btn" onclick="event.stopPropagation();callContact(${idx})" title="Call">ğŸ“</button>` : ''}
        <button class="contact-action-btn pay" onclick="event.stopPropagation();payContact(${idx})" title="Pay">ğŸ’¸</button>
      </div>
    </div>`;
  });
  container.innerHTML = html;
}

function filterContacts() {
  const q = document.getElementById('contactSearchInput').value.trim();
  renderContacts(q || undefined);
}

// â”€â”€ Contact Picker API (import from phone) â”€â”€
async function importPhoneContacts() {
  if (!('contacts' in navigator && 'ContactsManager' in window)) {
    alert('Contact Picker API is not supported on this device/browser.\n\nTry using Chrome on Android, or add contacts manually.');
    return;
  }
  try {
    const props = await navigator.contacts.getProperties();
    const supported = props.filter(p => ['name','tel','email'].includes(p));
    const results = await navigator.contacts.select(supported, { multiple: true });
    if (!results || !results.length) return;

    let added = 0;
    results.forEach(r => {
      const name = (r.name && r.name[0]) || 'Unknown';
      const phone = (r.tel && r.tel[0]) || '';
      const email = (r.email && r.email[0]) || '';
      // Skip duplicates (same name + phone)
      const exists = szContacts.some(c => c.name === name && c.phone === phone);
      if (!exists) {
        szContacts.push({ name, phone, email, payHandle: '', notes: '', source: 'phone', addedAt: Date.now() });
        added++;
      }
    });
    saveContacts();
    alert('âœ… Imported ' + added + ' new contact' + (added !== 1 ? 's' : '') + ' from your phone!');
  } catch (err) {
    if (err.name !== 'TypeError') console.error(err);
    alert('Could not import contacts. Make sure you\'re using Chrome on Android.');
  }
}

// â”€â”€ Add / Edit / Delete â”€â”€
function openAddContact() {
  editingContactIdx = -1;
  document.getElementById('cmTitle').textContent = 'Add Contact';
  document.getElementById('cmName').value = '';
  document.getElementById('cmPhone').value = '';
  document.getElementById('cmEmail').value = '';
  document.getElementById('cmPayHandle').value = '';
  document.getElementById('cmNotes').value = '';
  document.getElementById('cmDeleteBtn').style.display = 'none';
  document.getElementById('contactModal').classList.add('open');
}

function openEditContact(idx) {
  editingContactIdx = idx;
  const c = szContacts[idx];
  document.getElementById('cmTitle').textContent = 'Edit Contact';
  document.getElementById('cmName').value = c.name || '';
  document.getElementById('cmPhone').value = c.phone || '';
  document.getElementById('cmEmail').value = c.email || '';
  document.getElementById('cmPayHandle').value = c.payHandle || '';
  document.getElementById('cmNotes').value = c.notes || '';
  document.getElementById('cmDeleteBtn').style.display = '';
  document.getElementById('contactModal').classList.add('open');
}

function closeContactModal() {
  document.getElementById('contactModal').classList.remove('open');
  editingContactIdx = -1;
}

function saveContact() {
  const name = document.getElementById('cmName').value.trim();
  if (!name) { alert('Name is required'); return; }
  const data = {
    name,
    phone: document.getElementById('cmPhone').value.trim(),
    email: document.getElementById('cmEmail').value.trim(),
    payHandle: document.getElementById('cmPayHandle').value.trim(),
    notes: document.getElementById('cmNotes').value.trim(),
    addedAt: Date.now()
  };
  if (editingContactIdx >= 0) {
    data.source = szContacts[editingContactIdx].source || 'manual';
    szContacts[editingContactIdx] = data;
  } else {
    data.source = 'manual';
    szContacts.push(data);
  }
  saveContacts();
  closeContactModal();
}

function deleteContact() {
  if (editingContactIdx < 0) return;
  const c = szContacts[editingContactIdx];
  if (confirm('Delete ' + c.name + '?')) {
    szContacts.splice(editingContactIdx, 1);
    saveContacts();
    closeContactModal();
  }
}

// â”€â”€ Actions â”€â”€
function callContact(idx) {
  const c = szContacts[idx];
  if (c.phone) window.open('tel:' + c.phone.replace(/[^\d+]/g, ''));
}

function payContact(idx) {
  const c = szContacts[idx];
  // Switch to SubZero Pay and pre-fill note
  showScreen('szpay');
  setSZPayMode('request');
  const noteEl = document.getElementById('szpNote');
  if (noteEl) noteEl.value = 'Payment to ' + c.name + (c.payHandle ? ' (' + c.payHandle + ')' : '');
}

// â”€â”€ Export / Import backup â”€â”€
function exportContacts() {
  if (!szContacts.length) { alert('No contacts to export'); return; }
  const blob = new Blob([JSON.stringify(szContacts, null, 2)], { type: 'application/json' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = 'subzero-contacts-' + new Date().toISOString().slice(0,10) + '.json';
  a.click();
  URL.revokeObjectURL(url);
}

function importContactsFile() {
  document.getElementById('contactFileInput').click();
}

function handleContactFileImport(event) {
  const file = event.target.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = function(e) {
    try {
      const imported = JSON.parse(e.target.result);
      if (!Array.isArray(imported)) { alert('Invalid contacts file'); return; }
      let added = 0;
      imported.forEach(c => {
        if (!c.name) return;
        const exists = szContacts.some(x => x.name === c.name && x.phone === c.phone);
        if (!exists) {
          szContacts.push({
            name: c.name || 'Unknown',
            phone: c.phone || '',
            email: c.email || '',
            payHandle: c.payHandle || '',
            notes: c.notes || '',
            source: 'import',
            addedAt: Date.now()
          });
          added++;
        }
      });
      saveContacts();
      alert('âœ… Imported ' + added + ' contact' + (added !== 1 ? 's' : '') + ' from backup!');
    } catch (err) {
      alert('Failed to parse contacts file');
    }
  };
  reader.readAsText(file);
  event.target.value = ''; // Reset input
}

// Init contacts on load
renderContacts();
updateContactStats();

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  STATE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const API = location.origin;
const GITHUB = "https://github.com/jhawpetoss6-collab/subzero";
let messages = JSON.parse(localStorage.getItem('sz_messages') || '[]');
let darkMode = localStorage.getItem('sz_dark') !== 'false';
let model = localStorage.getItem('sz_model') || 'qwen2.5:1.5b';
let session = localStorage.getItem('sz_session') || crypto.randomUUID?.() || Date.now().toString();
let sending = false;
let ctxTarget = null;
let deferredPrompt = null;
localStorage.setItem('sz_session', session);

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  SCREENS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function showScreen(name) {
  document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
  document.getElementById('screen-' + name).classList.add('active');
  if (name === 'chat') {
    renderMessages();
    scrollToBottom();
    checkStatus();
  }
  if (name === 'income') loadIncome();
  closeMenus();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  DRAWER
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function openDrawer() { document.getElementById('drawer').classList.add('open'); document.getElementById('overlay').classList.add('open'); }
function closeDrawer() { document.getElementById('drawer').classList.remove('open'); document.getElementById('overlay').classList.remove('open'); }

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  THEME
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function applyTheme() {
  document.body.classList.toggle('light', !darkMode);
  const tog = document.getElementById('themeToggle');
  if (tog) tog.checked = darkMode;
  document.getElementById('theme-icon').textContent = darkMode ? 'ğŸŒ™' : 'â˜€ï¸';
  document.getElementById('theme-label').textContent = darkMode ? 'Dark Theme' : 'Light Theme';
  document.querySelector('meta[name="theme-color"]').content = darkMode ? '#0a0a12' : '#0a0a12';
  localStorage.setItem('sz_dark', darkMode);
}
function toggleTheme() { darkMode = !darkMode; applyTheme(); }
applyTheme();

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  MESSAGES
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderMessages() {
  const el = document.getElementById('messages');
  el.innerHTML = '<div class="msg-date">Today</div>';
  messages.forEach((m, i) => {
    const div = document.createElement('div');
    div.className = 'msg ' + m.role;
    div.dataset.index = i;
    let html = formatText(m.content);
    html += `<span class="time">${m.time || ''}`;
    if (m.role === 'user') html += ' <span class="check">âœ“âœ“</span>';
    html += '</span>';
    if (m.tools && m.tools.length) {
      m.tools.forEach(t => {
        const icon = t.success ? 'âœ…' : 'âŒ';
        html += `<div class="tool-result">${icon} <b>${t.tool}</b>: ${escHtml(t.output.substring(0,300))}</div>`;
      });
    }
    div.innerHTML = html;
    // Long press
    let timer;
    div.addEventListener('touchstart', e => { timer = setTimeout(() => showCtx(e, i), 500); });
    div.addEventListener('touchend', () => clearTimeout(timer));
    div.addEventListener('touchmove', () => clearTimeout(timer));
    div.addEventListener('contextmenu', e => { e.preventDefault(); showCtx(e, i); });
    el.appendChild(div);
  });
}

function formatText(text) {
  let t = escHtml(text);
  // Code blocks
  t = t.replace(/```(\w*)\n([\s\S]*?)```/g, '<pre>$2</pre>');
  t = t.replace(/`([^`]+)`/g, '<code>$1</code>');
  // Bold
  t = t.replace(/\*\*(.+?)\*\*/g, '<b>$1</b>');
  t = t.replace(/\*(.+?)\*/g, '<i>$1</i>');
  // Newlines
  t = t.replace(/\n/g, '<br>');
  return t;
}

function escHtml(t) {
  return t.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
}

function now() {
  return new Date().toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'});
}

function saveMessages() {
  localStorage.setItem('sz_messages', JSON.stringify(messages.slice(-100)));
  // Update home preview
  if (messages.length) {
    const last = messages[messages.length - 1];
    document.getElementById('lastPreview').textContent = last.content.substring(0, 50);
    document.getElementById('lastTime').textContent = last.time || 'now';
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  SEND MESSAGE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function sendMessage() {
  const input = document.getElementById('msgInput');
  const text = input.value.trim();
  if (!text || sending) return;

  // Add user message
  messages.push({ role:'user', content:text, time:now() });
  input.value = '';
  autoGrow(input);
  updateSend();
  renderMessages();
  scrollToBottom();
  saveMessages();

  // Show typing
  sending = true;
  document.getElementById('typing').classList.add('show');
  scrollToBottom();

  try {
    const res = await fetch(API + '/api/chat', {
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify({ message:text, session, model })
    });
    const data = await res.json();
    if (data.ok) {
      messages.push({ role:'bot', content:data.response, time:now(), tools:data.tools||[] });
    } else {
      messages.push({ role:'bot', content:'âš ï¸ ' + (data.error || 'Unknown error'), time:now() });
    }
  } catch (e) {
    messages.push({ role:'bot', content:'âš ï¸ Cannot reach Spine Rip server. Make sure sz_server.py is running on your PC and you\'re on the same WiFi.', time:now() });
  }

  sending = false;
  document.getElementById('typing').classList.remove('show');
  renderMessages();
  scrollToBottom();
  saveMessages();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  INPUT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function autoGrow(el) {
  el.style.height = 'auto';
  el.style.height = Math.min(el.scrollHeight, 120) + 'px';
}
function updateSend() {
  const btn = document.getElementById('sendBtn');
  const val = document.getElementById('msgInput').value.trim();
  btn.classList.toggle('disabled', !val);
}
// Enter to send (no shift)
document.getElementById('msgInput').addEventListener('keydown', e => {
  if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); sendMessage(); }
});

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  SCROLL
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function scrollToBottom() {
  const el = document.getElementById('messages');
  setTimeout(() => { el.scrollTop = el.scrollHeight; }, 50);
}
function onMessagesScroll() {
  const el = document.getElementById('messages');
  const atBottom = el.scrollHeight - el.scrollTop - el.clientHeight < 100;
  document.getElementById('scrollBtn').classList.toggle('show', !atBottom);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  CONTEXT MENU (long press)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function showCtx(e, idx) {
  ctxTarget = idx;
  const menu = document.getElementById('ctxMenu');
  const x = e.touches ? e.touches[0].clientX : e.clientX;
  const y = e.touches ? e.touches[0].clientY : e.clientY;
  menu.style.left = Math.min(x, window.innerWidth - 180) + 'px';
  menu.style.top = Math.min(y, window.innerHeight - 200) + 'px';
  menu.classList.add('open');
  navigator.vibrate?.(30);
}
function ctxAction(action) {
  const menu = document.getElementById('ctxMenu');
  menu.classList.remove('open');
  if (ctxTarget === null) return;
  const msg = messages[ctxTarget];
  if (action === 'copy') {
    navigator.clipboard?.writeText(msg.content);
  } else if (action === 'reply') {
    document.getElementById('msgInput').value = '> ' + msg.content.substring(0, 60) + '\n';
    document.getElementById('msgInput').focus();
  } else if (action === 'delete') {
    messages.splice(ctxTarget, 1);
    renderMessages();
    saveMessages();
  } else if (action === 'forward') {
    if (navigator.share) {
      navigator.share({ text: msg.content });
    } else {
      navigator.clipboard?.writeText(msg.content);
    }
  }
  ctxTarget = null;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  CHAT 3-DOT MENU
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function showChatMenu(e) {
  const menu = document.getElementById('chatMenu');
  menu.style.right = '8px';
  menu.style.top = '50px';
  menu.style.left = 'auto';
  menu.classList.add('open');
}
function closeChatMenu() { document.getElementById('chatMenu').classList.remove('open'); }

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  SEARCH
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function toggleSearch() { document.getElementById('homeSearch').classList.toggle('open'); }
function toggleChatSearch() { document.getElementById('chatSearch').classList.toggle('open'); }
function filterChats() { /* single chat, no-op for now */ }
function searchMessages() {
  const q = document.getElementById('chatSearchInput').value.toLowerCase();
  document.querySelectorAll('#messages .msg').forEach(el => {
    el.style.display = !q || el.textContent.toLowerCase().includes(q) ? '' : 'none';
  });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  ATTACH MENU
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function toggleAttach() { document.getElementById('attachMenu').classList.toggle('open'); }
function attachAction(type) {
  document.getElementById('attachMenu').classList.remove('open');
  const input = document.getElementById('msgInput');
  if (type === 'command') {
    input.value = '!';
    input.focus();
  } else if (type === 'tools') {
    input.value = '@tool ';
    input.focus();
  } else if (type === 'photo') {
    input.value = 'take a screenshot of my desktop';
    input.focus();
  } else if (type === 'file') {
    input.value = 'list files in ';
    input.focus();
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  CLOSE ALL MENUS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function closeMenus() {
  document.getElementById('ctxMenu').classList.remove('open');
  document.getElementById('chatMenu').classList.remove('open');
  document.getElementById('attachMenu').classList.remove('open');
}
document.addEventListener('click', e => {
  if (!e.target.closest('.ctx-menu') && !e.target.closest('.hbtn')) closeMenus();
});

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  SETTINGS / STATUS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const MODELS = ['qwen2.5:1.5b','llama3.2','codellama','deepseek-coder','mistral'];
function cycleModel() {
  let idx = MODELS.indexOf(model);
  idx = (idx + 1) % MODELS.length;
  model = MODELS[idx];
  localStorage.setItem('sz_model', model);
  document.getElementById('modelDisplay').textContent = model;
  document.getElementById('chatStatus').textContent = 'Spine Rip AI â€¢ online';
}
document.getElementById('modelDisplay').textContent = model;

async function checkStatus() {
  try {
    const r = await fetch(API + '/api/status');
    const d = await r.json();
    const s = d.ollama ? 'ğŸŸ¢ Connected' : 'ğŸ”´ Ollama offline';
    document.getElementById('connStatus').textContent = s + ' â€¢ ' + d.model;
    document.getElementById('chatStatus').textContent = 'Spine Rip AI â€¢ ' + (d.ollama ? 'online' : 'offline');
    document.getElementById('serverAddr').textContent = location.host;
  } catch {
    document.getElementById('connStatus').textContent = 'ğŸ”´ Server unreachable';
    document.getElementById('chatStatus').textContent = 'Spine Rip AI â€¢ offline';
  }
}

function clearHistory() {
  if (confirm('Clear all chat history?')) {
    messages = [];
    renderMessages();
    saveMessages();
    fetch(API + '/api/clear', {
      method:'POST', headers:{'Content-Type':'application/json'},
      body: JSON.stringify({session})
    }).catch(() => {});
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  WALLET
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function walletAction(action) {
  showScreen('chat');
  const input = document.getElementById('msgInput');
  if (action === 'send') input.value = 'I want to send crypto. Help me with the transaction.';
  else if (action === 'receive') input.value = 'Show me my wallet receive address';
  else if (action === 'swap') input.value = 'I want to swap tokens. What are current rates?';
  else if (action === 'buy') input.value = 'I want to buy crypto. What are the best options?';
  input.focus();
  updateSend();
}
function connectWallet(type) {
  alert(type + ' connection coming soon! For now, use the API key method below or ask Spine Rip to help set up your wallet.');
}
function saveCryptoKeys() {
  const key = document.getElementById('cryptoApiKey').value.trim();
  const secret = document.getElementById('cryptoApiSecret').value.trim();
  if (key && secret) {
    localStorage.setItem('sz_crypto_key', key);
    localStorage.setItem('sz_crypto_secret', secret);
    alert('API keys saved locally. Your keys never leave your device.');
    refreshWallet();
  } else {
    alert('Please enter both API Key and Secret.');
  }
}
function refreshWallet() {
  showScreen('chat');
  const input = document.getElementById('msgInput');
  input.value = 'Get me the current prices for Bitcoin, Ethereum, and Solana';
  input.focus();
  updateSend();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  TAP TO PAY
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let payCoin = 'USDT';
 let payNetwork = 'ETH';
 let payTxHistory = JSON.parse(localStorage.getItem('sz_pay_tx') || '[]');
 const payAddresses = JSON.parse(localStorage.getItem('sz_pay_addr') || '{}');
 let qrMethod = 'crypto';

function selectPayCoin(coin) {
  payCoin = coin;
  document.querySelectorAll('#payCoinSelect .pay-coin-btn').forEach(b => b.classList.remove('active'));
  event.target.classList.add('active');
  document.getElementById('payCoinLabel').textContent = coin;
  updatePayQR();
}

function selectPayNet(net) {
  payNetwork = net;
  document.querySelectorAll('#payNetworks .pay-net-btn').forEach(b => b.classList.remove('active'));
  event.target.classList.add('active');
  updatePayQR();
}

let feeConfig = { fee_percent: 2.9, fee_flat_cents: 30, fee_label: 'SubZero Processing Fee', owner_cashapp: '', owner_venmo: '', owner_crypto_eth: '' };

function updatePayQR() {
  const amt = document.getElementById('payAmount').value || '0';
  document.getElementById('payUsd').textContent = parseFloat(amt || 0).toFixed(2);
  // live-refresh QR if visible
  if (document.getElementById('payQRSection').style.display !== 'none') {
    showPayQR('receive');
  }
}

function selectQRMethod(method, ev) {
  qrMethod = method;
  document.querySelectorAll('#payQRMethods .pay-qr-btn').forEach(b=>b.classList.remove('active'));
  if (ev && ev.target) ev.target.classList.add('active');
  if (document.getElementById('payQRSection').style.display !== 'none') {
    showPayQR('receive');
  }
}

function getPayAddr() {
  const cents = Math.round(amountUsd * 100);
  const feeCents = Math.round(cents * feeConfig.fee_percent / 100) + feeConfig.fee_flat_cents;
  return { amount: amountUsd, fee: feeCents / 100, total: (cents + feeCents) / 100, feeCents, amountCents: cents };
}

function updateFeeDisplay() {
  const amt = parseFloat(document.getElementById('payAmount').value || '0');
  const box = document.getElementById('feeBreakdown');
  if (amt <= 0) { box.style.display = 'none'; return; }
  const f = calcFee(amt);
  box.style.display = 'block';
  document.getElementById('fbAmount').textContent = '$' + amt.toFixed(2);
  document.getElementById('fbPct').textContent = feeConfig.fee_percent;
  document.getElementById('fbFlat').textContent = (feeConfig.fee_flat_cents / 100).toFixed(2);
  document.getElementById('fbFee').textContent = '$' + f.fee.toFixed(2);
  document.getElementById('fbTotal').textContent = '$' + f.total.toFixed(2);
}

async function recordFeeToServer(method, amountCents, detail) {
  try {
    await fetch(API + '/api/payments/record-fee', {
      method: 'POST', headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({ method, amount_cents: amountCents, detail })
    });
  } catch(e) { console.log('Fee record failed:', e); }
}

async function loadFeeConfig() {
  try {
    const r = await fetch(API + '/api/payments/config');
    const d = await r.json();
    if (d.ok) {
      feeConfig.fee_percent = d.fee_percent || 2.9;
      feeConfig.fee_flat_cents = d.fee_flat_cents || 30;
      feeConfig.fee_label = d.fee_label || 'SubZero Processing Fee';
      feeConfig.owner_cashapp = d.owner_cashapp || '';
      feeConfig.owner_venmo = d.owner_venmo || '';
      feeConfig.owner_crypto_eth = d.owner_crypto_eth || '';
    }
  } catch(e) {}
}
loadFeeConfig();

function getPayAddr() {
  const key = payNetwork + '_' + payCoin;
  if (payAddresses[key]) return payAddresses[key];
  const saved = localStorage.getItem('sz_wallet_addr_' + payNetwork);
  if (saved) return saved;
  return 'No address configured â€” enter in Wallet settings';
}

function buildPayLink(method, amt) {
  const a = parseFloat(amt || '0');
  if (method === 'cashapp') {
    if (!feeConfig.owner_cashapp) { alert('Set your $Cashtag in settings (payments.json) first.'); return ''; }
    const tag = feeConfig.owner_cashapp.startsWith('$') ? feeConfig.owner_cashapp.slice(1) : feeConfig.owner_cashapp;
    return 'https://cash.app/' + tag + '/' + a.toFixed(2);
  }
  if (method === 'venmo') {
    if (!feeConfig.owner_venmo) { alert('Set your Venmo @username in settings (payments.json) first.'); return ''; }
    const user = feeConfig.owner_venmo.startsWith('@') ? feeConfig.owner_venmo.slice(1) : feeConfig.owner_venmo;
    return 'https://venmo.com/' + user + '?txn=pay&amount=' + a.toFixed(2) + '&note=' + encodeURIComponent('SubZero Payment');
  }
  // crypto default
  const addr = getPayAddr();
  return addr + '?amount=' + a.toFixed(2) + '&coin=' + payCoin + '&net=' + payNetwork;
}

function showPayQR(mode) {
  const section = document.getElementById('payQRSection');
  const amt = document.getElementById('payAmount').value || '0';
  section.style.display = 'block';
  if (mode === 'receive') {
    const link = buildPayLink(qrMethod, amt);
    document.getElementById('payQRLabel').textContent = 'Scan to pay (' + (qrMethod === 'crypto' ? payCoin + ' â€¢ ' + payNetwork : qrMethod) + ')';
    document.getElementById('payAddr').textContent = link || 'â€”';
    const data = encodeURIComponent(link);
    document.getElementById('payQRImg').src = 'https://api.qrserver.com/v1/create-qr-code/?size=160x160&data=' + data + '&bgcolor=0a0a12&color=03dac6';
  } else {
    document.getElementById('payQRLabel').textContent = 'Scan recipient QR to send ' + amt + ' ' + payCoin;
    document.getElementById('payQRImg').src = '';
    startQRScanner();
  }
}

function copyPayAddr() {
  const addr = document.getElementById('payAddr').textContent;
  navigator.clipboard?.writeText(addr);
  document.getElementById('payAddr').textContent = 'âœ… Copied!';
  setTimeout(() => { document.getElementById('payAddr').textContent = addr; }, 1500);
}

async function tapToPay() {
  const amt = document.getElementById('payAmount').value;
  if (!amt || parseFloat(amt) <= 0) {
    alert('Enter an amount first');
    return;
  }

  // Try NFC first (Android Chrome)
  if ('NDEFReader' in window) {
    try {
      const ndef = new NDEFReader();
      const payData = JSON.stringify({
        app: 'SubZero', coin: payCoin, network: payNetwork,
        amount: amt, addr: getPayAddr(), ts: Date.now()
      });

      // Check if we should write (send) or read (receive)
      document.getElementById('tapPayBtn').querySelector('.tap-label').textContent = 'HOLD NEAR...';
      document.getElementById('tapPayBtn').style.borderColor = '#ffab00';

      await ndef.scan();
      ndef.onreading = (event) => {
        // Received a tap â€” parse payment
        for (const record of event.message.records) {
          if (record.recordType === 'text') {
            const decoder = new TextDecoder();
            const data = JSON.parse(decoder.decode(record.data));
            if (data.app === 'SubZero') {
              addPayTx('received', data.amount, data.coin, data.network, 'NFC Tap');
              alert('âœ… Received ' + data.amount + ' ' + data.coin + ' via NFC!');
            }
          }
        }
        resetTapBtn();
      };

      // Also write our payment request
      await ndef.write({ records: [{ recordType: 'text', data: payData }] });
      addPayTx('sent', amt, payCoin, payNetwork, 'NFC Tap');
      alert('âœ… Payment of ' + amt + ' ' + payCoin + ' sent via NFC!');
      resetTapBtn();
    } catch (e) {
      if (e.name === 'NotAllowedError') {
        alert('NFC permission denied. Go to Settings > Site permissions > NFC');
      } else {
        // NFC not available â€” fall back to QR
        showPayQR('receive');
      }
      resetTapBtn();
    }
  } else {
    // No NFC â€” show QR instead
    showPayQR('receive');
    navigator.vibrate?.([100, 50, 100]);
  }
}

function resetTapBtn() {
  document.getElementById('tapPayBtn').querySelector('.tap-label').textContent = 'TAP TO PAY';
  document.getElementById('tapPayBtn').style.borderColor = 'var(--accent)';
}

function addPayTx(type, amount, coin, network, method) {
  const f = calcFee(parseFloat(amount) || 0);
  const tx = {
    type, amount, coin, network, method,
    fee: f.fee.toFixed(2),
    total: f.total.toFixed(2),
    time: new Date().toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'}),
    date: new Date().toLocaleDateString(),
  };
  payTxHistory.unshift(tx);
  if (payTxHistory.length > 50) payTxHistory = payTxHistory.slice(0, 50);
  localStorage.setItem('sz_pay_tx', JSON.stringify(payTxHistory));
  renderPayTx();
  // Record fee income on the server
  if (type === 'sent' && parseFloat(amount) > 0) {
    recordFeeToServer(method, f.amountCents, coin + ' on ' + network);
  }
}

function renderPayTx() {
  const el = document.getElementById('payTxList');
  if (!payTxHistory.length) {
    el.innerHTML = '<div style="text-align:center;color:var(--fg-dim);font-size:13px;padding:20px;">No transactions yet.</div>';
    return;
  }
  el.innerHTML = payTxHistory.slice(0, 10).map(tx => `
    <div class="pay-tx">
      <span class="ptx-icon">${tx.type === 'sent' ? 'â†—ï¸' : 'â†™ï¸'}</span>
      <div class="ptx-info">
        <div class="ptx-type">${tx.type === 'sent' ? 'Sent' : 'Received'} via ${tx.method}</div>
        <div class="ptx-time">${tx.date} ${tx.time} â€¢ ${tx.network}${tx.fee && tx.fee !== '0.00' ? ' â€¢ fee: $' + tx.fee : ''}</div>
      </div>
      <div class="ptx-amount ${tx.type}">${tx.type === 'sent' ? '-' : '+'}${tx.amount} ${tx.coin}</div>
    </div>
  `).join('');
}
renderPayTx();

let scanStream=null, scanTimer=null;
async function startQRScanner() {
  const overlay=document.getElementById('scanOverlay');
  const video=document.getElementById('scanVideo');
  overlay.classList.add('open');
  try{
    scanStream=await navigator.mediaDevices.getUserMedia({video:{facingMode:'environment'}});
    video.srcObject=scanStream;
    await video.play();
    const detector=('BarcodeDetector' in window)? new BarcodeDetector({formats:['qr_code']}) : null;
    const canvas=document.createElement('canvas');
    const ctx=canvas.getContext('2d');
    async function tick(){
      if(!overlay.classList.contains('open')) return;
      canvas.width=video.videoWidth; canvas.height=video.videoHeight;
      ctx.drawImage(video,0,0,canvas.width,canvas.height);
      if(detector){
        try{
          const codes=await detector.detect(canvas);
          if(codes && codes.length){ onQRDetected(codes[0].rawValue); return; }
        }catch{}
      }
      scanTimer=requestAnimationFrame(tick);
    }
    scanTimer=requestAnimationFrame(tick);
  }catch(e){
    alert('Camera unavailable. Grant permission or use the device browser camera.');
    stopQRScanner();
  }
}
function stopQRScanner(){
  document.getElementById('scanOverlay').classList.remove('open');
  if(scanTimer){ cancelAnimationFrame(scanTimer); scanTimer=null; }
  if(scanStream){ scanStream.getTracks().forEach(t=>t.stop()); scanStream=null; }
}
function onQRDetected(text){
  stopQRScanner();
  // Handle SubZero scheme or external links
  if(text.startsWith('subzero:pay')){
    const q=new URLSearchParams(text.split('?')[1]||'');
    const amt=parseFloat(q.get('amount')||'0');
    const route=q.get('route')||'cashapp';
    if(route==='cashapp'){
      const tag=q.get('cashapp')||feeConfig.owner_cashapp||''; const t=tag.replace('$','');
      const url='https://cash.app/'+t+'/'+amt.toFixed(2);
      if(confirm('Pay $'+amt.toFixed(2)+' via Cash App?')) window.open(url,'_blank');
    }else if(route==='venmo'){
      const user=(q.get('venmo')||feeConfig.owner_venmo||'').replace('@','');
      const url='https://venmo.com/'+user+'?txn=pay&amount='+amt.toFixed(2)+'&note='+encodeURIComponent(q.get('note')||'SubZero Payment');
      if(confirm('Pay $'+amt.toFixed(2)+' via Venmo?')) window.open(url,'_blank');
    }else{
      const addr=q.get('addr')||getPayAddr();
      document.getElementById('payAmount').value=amt.toFixed(2);
      updateFeeDisplay();
      showPayQR('receive');
      alert('Crypto payment requested. Address copied to QR section.');
    }
    return;
  }
  if(text.includes('cash.app/')){
    if(confirm('Open Cash App to pay?')) window.open(text,'_blank');
    return;
  }
  if(text.includes('venmo.com/')){
    if(confirm('Open Venmo to pay?')) window.open(text,'_blank');
    return;
  }
  // SubZero email QR
  if(text.startsWith('subzero:email')){
    handleEmailQR(text);
    return;
  }
  // SubZero mail stablecoin transfer QR
  if(text.startsWith('subzero:mailtx')){
    handleMailTxQR(text);
    return;
  }
  // Fallback: show raw content
  alert('Scanned: '+text);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  GOOGLE PAY & GOOGLE WALLET
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let gpayClient = null;
let gpayReady = false;

const GPAY_BASE_CONFIG = {
  apiVersion: 2,
  apiVersionMinor: 0
};

const GPAY_ALLOWED_METHODS = [{
  type: 'CARD',
  parameters: {
    allowedAuthMethods: ['PAN_ONLY', 'CRYPTOGRAM_3DS'],
    allowedCardNetworks: ['VISA', 'MASTERCARD', 'AMEX', 'DISCOVER']
  },
  tokenizationSpecification: {
    type: 'PAYMENT_GATEWAY',
    parameters: {
      gateway: 'example',
      gatewayMerchantId: 'SubZeroWallet'
    }
  }
}];

const GPAY_MERCHANT_INFO = {
  merchantId: 'BCR2DN4T7SUBZERO',
  merchantName: 'SubZero Wallet'
};

function loadGPayScript() {
  return new Promise((resolve, reject) => {
    if (window.google?.payments?.api?.PaymentsClient) { resolve(); return; }
    const s = document.createElement('script');
    s.src = 'https://pay.google.com/gp/p/js/pay.js';
    s.onload = resolve;
    s.onerror = reject;
    document.head.appendChild(s);
  });
}

async function initGooglePay() {
  const statusEl = document.getElementById('gpayStatus');
  statusEl.textContent = 'Loading Google Pay...';
  statusEl.className = 'gpay-status';

  try {
    await loadGPayScript();
    gpayClient = new google.payments.api.PaymentsClient({ environment: 'TEST' });

    const resp = await gpayClient.isReadyToPay({
      ...GPAY_BASE_CONFIG,
      allowedPaymentMethods: GPAY_ALLOWED_METHODS.map(m => ({
        type: m.type, parameters: m.parameters
      }))
    });

    if (resp.result) {
      gpayReady = true;
      statusEl.textContent = 'âœ… Google Pay is linked and ready!';
      statusEl.className = 'gpay-status success';
      localStorage.setItem('sz_gpay_linked', 'true');
      document.getElementById('gpayLinkBtn').innerHTML = `
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none"><path d="M12.24 10.285V14.4h6.806c-.275 1.765-2.056 5.174-6.806 5.174-4.095 0-7.439-3.389-7.439-7.574s3.345-7.574 7.439-7.574c2.33 0 3.891.989 4.785 1.849l3.254-3.138C18.189 1.186 15.479 0 12.24 0c-6.635 0-12 5.365-12 12s5.365 12 12 12c6.926 0 11.52-4.869 11.52-11.726 0-.788-.085-1.39-.189-1.989H12.24z" fill="#4285F4"/></svg>
        âœ“ Google Pay Linked`;
    } else {
      statusEl.textContent = 'Google Pay not available on this device/browser.';
      statusEl.className = 'gpay-status error';
    }
  } catch (e) {
    statusEl.textContent = 'âš ï¸ ' + (e.message || 'Could not load Google Pay. Try Chrome on Android.');
    statusEl.className = 'gpay-status error';
  }
}

async function googlePayCheckout() {
  const amt = document.getElementById('payAmount').value;
  if (!amt || parseFloat(amt) <= 0) {
    alert('Enter an amount first');
    return;
  }

  try {
    if (!gpayClient || !gpayReady) {
      await loadGPayScript();
      gpayClient = new google.payments.api.PaymentsClient({ environment: 'TEST' });
      gpayReady = true;
    }

    const paymentDataRequest = {
      ...GPAY_BASE_CONFIG,
      allowedPaymentMethods: GPAY_ALLOWED_METHODS,
      transactionInfo: {
        totalPriceStatus: 'FINAL',
        totalPrice: parseFloat(amt).toFixed(2),
        currencyCode: 'USD',
        countryCode: 'US'
      },
      merchantInfo: GPAY_MERCHANT_INFO
    };

    const payData = await gpayClient.loadPaymentData(paymentDataRequest);
    // Payment authorized â€” record it + fee
    const token = payData.paymentMethodData.tokenizationData.token;
    const f = calcFee(parseFloat(amt));
    addPayTx('sent', amt, payCoin, payNetwork, 'Google Pay');
    alert('âœ… Google Pay payment of $' + f.total.toFixed(2) + ' authorized!\n(includes $' + f.fee.toFixed(2) + ' processing fee)');
    console.log('GPay token:', token);
  } catch (e) {
    if (e.statusCode === 'CANCELED') {
      // User cancelled â€” no alert
    } else {
      alert('Google Pay error: ' + (e.statusMessage || e.message || 'Unknown error'));
    }
  }
}

function addToGoogleWallet() {
  const statusEl = document.getElementById('gpayStatus');

  // Build the SubZero loyalty/wallet pass object
  const walletObj = {
    iss: 'subzero-wallet@subzero.iam.gserviceaccount.com',
    aud: 'google',
    typ: 'savetowallet',
    iat: Math.floor(Date.now() / 1000),
    payload: {
      genericObjects: [{
        id: 'SubZero.wallet_' + session,
        classId: 'SubZero.subzero_wallet_pass',
        genericType: 'GENERIC_TYPE_UNSPECIFIED',
        hexBackgroundColor: '#0a0a12',
        logo: {
          sourceUri: { uri: 'https://jhawpetoss6-collab.github.io/subzero/icon-192.png' }
        },
        cardTitle: { defaultValue: { language: 'en', value: 'SubZero Wallet' } },
        subheader: { defaultValue: { language: 'en', value: 'Crypto Wallet' } },
        header: { defaultValue: { language: 'en', value: 'Flawless Victory' } },
        barcode: {
          type: 'QR_CODE',
          value: 'subzero:wallet:' + session
        },
        textModulesData: [
          { id: 'wallet_id', header: 'Wallet ID', body: session.substring(0, 8).toUpperCase() },
          { id: 'network', header: 'Networks', body: 'ETH â€¢ BSC â€¢ Polygon â€¢ SOL' },
          { id: 'coins', header: 'Stablecoins', body: 'USDT â€¢ USDC â€¢ DAI â€¢ BUSD' }
        ]
      }]
    }
  };

  // Encode as JWT-like token for the save link (demo â€” real production uses signed JWT)
  const encoded = btoa(JSON.stringify(walletObj)).replace(/=/g, '').replace(/\+/g, '-').replace(/\//g, '_');

  // Open Google Wallet save URL
  const walletUrl = 'https://pay.google.com/gp/v/save/' + encoded;

  statusEl.textContent = 'ğŸ”„ Opening Google Wallet...';
  statusEl.className = 'gpay-status';

  // Try to open in new window/tab
  const win = window.open(walletUrl, '_blank');
  if (win) {
    statusEl.textContent = 'âœ… Google Wallet opened â€” follow the prompts to add your pass!';
    statusEl.className = 'gpay-status success';
    localStorage.setItem('sz_gwallet_added', 'true');
  } else {
    // Fallback: copy link
    navigator.clipboard?.writeText(walletUrl);
    statusEl.innerHTML = 'âš ï¸ Pop-up blocked. <a href="' + walletUrl + '" target="_blank" style="color:var(--accent)">Tap here to add to Google Wallet</a>';
    statusEl.className = 'gpay-status error';
  }
}

// Auto-restore GPay linked state
if (localStorage.getItem('sz_gpay_linked') === 'true') {
  const btn = document.getElementById('gpayLinkBtn');
  if (btn) {
    btn.innerHTML = `
      <svg width="18" height="18" viewBox="0 0 24 24" fill="none"><path d="M12.24 10.285V14.4h6.806c-.275 1.765-2.056 5.174-6.806 5.174-4.095 0-7.439-3.389-7.439-7.574s3.345-7.574 7.439-7.574c2.33 0 3.891.989 4.785 1.849l3.254-3.138C18.189 1.186 15.479 0 12.24 0c-6.635 0-12 5.365-12 12s5.365 12 12 12c6.926 0 11.52-4.869 11.52-11.726 0-.788-.085-1.39-.189-1.989H12.24z" fill="#4285F4"/></svg>
      âœ“ Google Pay Linked`;
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  NETSPEND / CASH APP / VENMO
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// â€” Netspend â€”
function linkNetspend() {
  const card = document.getElementById('netspendCard').value.trim();
  if (!card || card.length < 4) { alert('Enter your Netspend card number (at least last 4 digits).'); return; }
  const masked = 'â€¢â€¢â€¢â€¢' + card.slice(-4);
  localStorage.setItem('sz_netspend', masked);
  showNetspendLinked(masked);
  addPayTx('received', '0', 'USD', 'Netspend', 'Card Linked');
  alert('âœ… Netspend card ' + masked + ' linked to SubZero!');
}

function showNetspendLinked(tag) {
  document.getElementById('netspendLinked').style.display = 'flex';
  document.getElementById('netspendTag').textContent = tag;
  document.getElementById('netspendSetup').style.display = 'none';
  document.getElementById('netspendActions').style.display = 'flex';
}

function netspendAction(action) {
  const tag = localStorage.getItem('sz_netspend');
  if (action === 'load') {
    const amt = prompt('Amount to load onto Netspend card (' + tag + '):', '25.00');
    if (amt && parseFloat(amt) > 0) {
      addPayTx('sent', amt, 'USD', 'Netspend', 'Load to Card');
      alert('âœ… $' + parseFloat(amt).toFixed(2) + ' loaded to Netspend ' + tag);
    }
  } else {
    const amt = prompt('Amount to withdraw from Netspend to SubZero wallet:', '25.00');
    if (amt && parseFloat(amt) > 0) {
      addPayTx('received', amt, 'USD', 'Netspend', 'Withdraw from Card');
      alert('âœ… $' + parseFloat(amt).toFixed(2) + ' withdrawn from Netspend ' + tag + ' to wallet');
    }
  }
}

function netspendCheckout() {
  const amt = document.getElementById('payAmount').value;
  if (!amt || parseFloat(amt) <= 0) { alert('Enter an amount first'); return; }
  if (!localStorage.getItem('sz_netspend')) { alert('Link your Netspend card first in the Wallet screen.'); return; }
  const tag = localStorage.getItem('sz_netspend');
  const f = calcFee(parseFloat(amt));
  if (confirm('Pay $' + f.total.toFixed(2) + ' with Netspend ' + tag + '?\n\nAmount: $' + parseFloat(amt).toFixed(2) + '\nFee: $' + f.fee.toFixed(2) + '\nTotal: $' + f.total.toFixed(2))) {
    addPayTx('sent', amt, 'USD', 'Netspend', 'Netspend Pay');
    alert('\u2705 $' + f.total.toFixed(2) + ' paid via Netspend ' + tag + ' (includes $' + f.fee.toFixed(2) + ' fee)');
  }
}

// â€” Cash App â€”
function linkCashApp() {
  let tag = document.getElementById('cashappHandle').value.trim();
  if (!tag) { alert('Enter your $Cashtag.'); return; }
  if (!tag.startsWith('$')) tag = '$' + tag;
  localStorage.setItem('sz_cashapp', tag);
  showCashAppLinked(tag);
  addPayTx('received', '0', 'USD', 'Cash App', 'Account Linked');
  alert('âœ… Cash App ' + tag + ' linked to SubZero!');
}

function showCashAppLinked(tag) {
  document.getElementById('cashappLinked').style.display = 'flex';
  document.getElementById('cashappTag').textContent = tag;
  document.getElementById('cashappSetup').style.display = 'none';
  document.getElementById('cashappActions').style.display = 'flex';
}

function cashAppAction(action) {
  const tag = localStorage.getItem('sz_cashapp');
  if (action === 'send') {
    const to = prompt('Send to $Cashtag:');
    const amt = prompt('Amount (USD):');
    if (to && amt && parseFloat(amt) > 0) {
      // Deep link into Cash App
      const url = 'https://cash.app/' + (to.startsWith('$') ? to.slice(1) : to) + '/' + parseFloat(amt).toFixed(2);
      window.open(url, '_blank');
      addPayTx('sent', amt, 'USD', 'Cash App', 'Send to ' + to);
    }
  } else {
    const amt = prompt('Request amount (USD):');
    if (amt && parseFloat(amt) > 0) {
      const url = 'https://cash.app/' + tag.slice(1) + '/' + parseFloat(amt).toFixed(2);
      navigator.clipboard?.writeText(url);
      addPayTx('received', amt, 'USD', 'Cash App', 'Payment Request');
      alert('âœ… Request link copied! Share it to receive $' + parseFloat(amt).toFixed(2) + '\n\n' + url);
    }
  }
}

function cashAppCheckout() {
  const amt = document.getElementById('payAmount').value;
  if (!amt || parseFloat(amt) <= 0) { alert('Enter an amount first'); return; }
  const tag = localStorage.getItem('sz_cashapp');
  if (!tag) { alert('Link your Cash App first in the Wallet screen.'); return; }
  const f = calcFee(parseFloat(amt));
  // Send the full amount (amt) to merchant, then fee goes to owner's Cash App
  const url = 'https://cash.app/' + tag.slice(1) + '/' + parseFloat(amt).toFixed(2);
  window.open(url, '_blank');
  addPayTx('sent', amt, 'USD', 'Cash App', 'Cash App Pay');
  // If owner has a Cash App, send fee there too
  if (feeConfig.owner_cashapp) {
    setTimeout(() => {
      const feeUrl = 'https://cash.app/' + feeConfig.owner_cashapp.replace('$','') + '/' + f.fee.toFixed(2);
      if (confirm('Processing fee: $' + f.fee.toFixed(2) + '\nTap OK to pay the SubZero fee via Cash App.')) {
        window.open(feeUrl, '_blank');
      }
    }, 1500);
  }
}

// â€” Venmo â€”
function linkVenmo() {
  let tag = document.getElementById('venmoHandle').value.trim();
  if (!tag) { alert('Enter your Venmo username.'); return; }
  if (!tag.startsWith('@')) tag = '@' + tag;
  localStorage.setItem('sz_venmo', tag);
  showVenmoLinked(tag);
  addPayTx('received', '0', 'USD', 'Venmo', 'Account Linked');
  alert('âœ… Venmo ' + tag + ' linked to SubZero!');
}

function showVenmoLinked(tag) {
  document.getElementById('venmoLinked').style.display = 'flex';
  document.getElementById('venmoTag').textContent = tag;
  document.getElementById('venmoSetup').style.display = 'none';
  document.getElementById('venmoActions').style.display = 'flex';
}

function venmoAction(action) {
  const tag = localStorage.getItem('sz_venmo');
  if (action === 'pay') {
    const to = prompt('Pay to Venmo user:');
    const amt = prompt('Amount (USD):');
    const note = prompt('Note (optional):', 'Sent via SubZero');
    if (to && amt && parseFloat(amt) > 0) {
      const user = to.startsWith('@') ? to.slice(1) : to;
      const url = 'https://venmo.com/' + user + '?txn=pay&amount=' + parseFloat(amt).toFixed(2) + '&note=' + encodeURIComponent(note || 'SubZero');
      window.open(url, '_blank');
      addPayTx('sent', amt, 'USD', 'Venmo', 'Pay to @' + user);
    }
  } else {
    const amt = prompt('Request amount (USD):');
    const note = prompt('Note (optional):', 'via SubZero');
    if (amt && parseFloat(amt) > 0) {
      const user = tag.startsWith('@') ? tag.slice(1) : tag;
      const url = 'https://venmo.com/' + user + '?txn=charge&amount=' + parseFloat(amt).toFixed(2) + '&note=' + encodeURIComponent(note || 'SubZero');
      navigator.clipboard?.writeText(url);
      addPayTx('received', amt, 'USD', 'Venmo', 'Payment Request');
      alert('âœ… Venmo request link copied!\n\n' + url);
    }
  }
}

function venmoCheckout() {
  const amt = document.getElementById('payAmount').value;
  if (!amt || parseFloat(amt) <= 0) { alert('Enter an amount first'); return; }
  const tag = localStorage.getItem('sz_venmo');
  if (!tag) { alert('Link your Venmo first in the Wallet screen.'); return; }
  const f = calcFee(parseFloat(amt));
  const user = tag.startsWith('@') ? tag.slice(1) : tag;
  const url = 'https://venmo.com/' + user + '?txn=pay&amount=' + parseFloat(amt).toFixed(2) + '&note=' + encodeURIComponent('SubZero Payment');
  window.open(url, '_blank');
  addPayTx('sent', amt, 'USD', 'Venmo', 'Venmo Pay');
  // If owner has a Venmo, prompt fee payment
  if (feeConfig.owner_venmo) {
    setTimeout(() => {
      const ownerUser = feeConfig.owner_venmo.replace('@','');
      const feeUrl = 'https://venmo.com/' + ownerUser + '?txn=pay&amount=' + f.fee.toFixed(2) + '&note=' + encodeURIComponent('SubZero Processing Fee');
      if (confirm('Processing fee: $' + f.fee.toFixed(2) + '\nTap OK to pay the SubZero fee via Venmo.')) {
        window.open(feeUrl, '_blank');
      }
    }, 1500);
  }
}

// Restore linked accounts on load
(function restorePayServices() {
  const ns = localStorage.getItem('sz_netspend');
  if (ns) showNetspendLinked(ns);
  const ca = localStorage.getItem('sz_cashapp');
  if (ca) showCashAppLinked(ca);
  const vm = localStorage.getItem('sz_venmo');
  if (vm) showVenmoLinked(vm);
})();

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  INCOME DASHBOARD
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function loadIncome() {
  try {
    const r = await fetch(API + '/api/payments/income');
    const d = await r.json();
    if (!d.ok) return;
    const totalFee = (d.total_fee_cents / 100).toFixed(2);
    const totalVol = (d.total_volume_cents / 100).toFixed(2);
    const avgFee = d.tx_count > 0 ? (d.total_fee_cents / d.tx_count / 100).toFixed(2) : '0.00';
    document.getElementById('dashIncome').textContent = '$' + totalFee;
    document.getElementById('dashSub').textContent = d.tx_count + ' transactions';
    document.getElementById('dashVolume').textContent = '$' + totalVol;
    document.getElementById('dashTxCount').textContent = d.tx_count;
    document.getElementById('dashAvgFee').textContent = '$' + avgFee;
    // Settings preview
    document.getElementById('incomeTotal').textContent = '$' + totalFee;
    document.getElementById('incomePreview').textContent = d.tx_count + ' transactions â€¢ $' + totalVol + ' volume';
    // Recent list
    const el = document.getElementById('dashTxList');
    if (d.recent && d.recent.length) {
      el.innerHTML = d.recent.map(tx => {
        const ts = new Date(tx.ts);
        const time = ts.toLocaleDateString() + ' ' + ts.toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'});
        return `<div class="income-tx">
          <span class="itx-method">${tx.method}</span>
          <span class="itx-fee">+$${(tx.fee_cents / 100).toFixed(2)}</span>
          <span class="itx-time">${time}</span>
        </div>`;
      }).join('');
    }
  } catch(e) {
    console.log('Income load failed:', e);
  }
}
// Load income on init and when navigating to income screen
loadIncome();

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  SHARE / QR
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function generateQR() {
  // Use a QR API to generate the GitHub repo QR
  const url = encodeURIComponent(GITHUB);
  document.getElementById('qrImage').src = `https://api.qrserver.com/v1/create-qr-code/?size=200x200&data=${url}&bgcolor=000000&color=0088ff`;
}
generateQR();

function shareApp() {
  if (navigator.share) {
    navigator.share({ title:'SubZero', text:'Check out SubZero â€” Flawless Victory AI', url:GITHUB });
  } else {
    copyLink();
  }
}
function copyLink() {
  navigator.clipboard?.writeText(GITHUB);
  alert('Link copied: ' + GITHUB);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  PWA INSTALL
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
window.addEventListener('beforeinstallprompt', e => {
  e.preventDefault();
  deferredPrompt = e;
  document.getElementById('installBanner').classList.add('show');
});
function installApp() {
  if (deferredPrompt) {
    deferredPrompt.prompt();
    deferredPrompt.userChoice.then(() => { deferredPrompt = null; });
  }
  document.getElementById('installBanner').classList.remove('show');
}
function dismissInstall() {
  document.getElementById('installBanner').classList.remove('show');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  INIT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
renderMessages();
checkStatus();
if ('serviceWorker' in navigator) {
  navigator.serviceWorker.register('sw.js').catch(() => {});
}
</script>
</body>
</html>
